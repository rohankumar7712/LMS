<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Assignment History</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body { background-color: #f4f6f9; }
    .sidebar {
      height: 100vh;
      background-color: #2A5C88;
      color: white;
      padding: 1rem;
      position: fixed;
      width: 250px;
    }
    .sidebar a {
      display: block;
      padding: 0.75rem 1rem;
      color: white;
      text-decoration: none;
      margin-bottom: 0.5rem;
      border-radius: 8px;
    }
    .sidebar a:hover,
    .sidebar a.active {
      background-color: #1f4568;
    }
    .main-content {
      margin-left: 270px;
      padding: 2rem;
    }
    .card {
      margin-bottom: 1rem;
      border-radius: 10px;
      border: 1px solid #ddd;
    }
    .nested-section {
      margin-left: 2rem;
      margin-top: 0.5rem;
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <h4 class="mb-4">Admin Panel</h4>
    <a href="create_assignment.html">Create Assignment</a>
     <a href="create_Code_Assignment.html">create code Assignment </a>
    <a class="active" href="create_assignment_History.html">Assignment History</a>
    <a href="admin-dashboard.html">← Back</a>
  </div>

  <div class="main-content">
    <h2 class="mb-4">Assignment History</h2>
    <div id="courseContainer"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAPFlx9gVV6Q0a8Bwv4Et0OfytgIWApQng",
      authDomain: "clms-3b972.firebaseapp.com",
      projectId: "clms-3b972",
      storageBucket: "clms-3b972.appspot.com",
      messagingSenderId: "213199198013",
      appId: "1:213199198013:web:4a576ce4f4af68469b1754"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const courseContainer = document.getElementById("courseContainer");

    async function loadAssignments() {
  const snapshot = await getDocs(collection(db, "courses"));
  const snapshot_1 = await getDocs(collection(db, "assignments"));
  const assignmentsByCourse = {};

  // Prepare assignments grouped by courseId
  snapshot_1.forEach(doc => {
    const data = doc.data();
    const courseId = data.courseId;
    const week = data.week || 1;
    const subject = data.subject || "Unknown Subject";

    if (!assignmentsByCourse[courseId]) {
      assignmentsByCourse[courseId] = { weeks: {} };
    }

    if (!assignmentsByCourse[courseId].weeks[week]) {
      assignmentsByCourse[courseId].weeks[week] = {};
    }

    assignmentsByCourse[courseId].weeks[week][subject] = {
      ...data,
      docId: doc.id
    };
  });

  // Now build course cards using data from `courses` collection
  snapshot.forEach(doc => {
    const courseId = doc.id; // ✅ Use the document ID as the courseId
    const data = doc.data();

    const course = {
      courseName: data.title || "Untitled Course",
      startDate: data.startDate || "N/A",
      endDate: data.endDate || "N/A",
      weeks: assignmentsByCourse[courseId]?.weeks || {}
    };

    // Build UI as before
    const courseCard = document.createElement("div");
    courseCard.className = "card p-3";
    courseCard.innerHTML = `
      <h5>${course.courseName}</h5>
      <p><strong>Start:</strong> ${course.startDate} | <strong>End:</strong> ${course.endDate}</p>
      <button class="btn btn-primary btn-sm">Enter</button>
      <div class="nested-section" style="display: none;"></div>
    `;

    const toggleBtn = courseCard.querySelector("button");
    const nestedSection = courseCard.querySelector(".nested-section");

    toggleBtn.addEventListener("click", () => {
      nestedSection.style.display = nestedSection.style.display === "none" ? "block" : "none";

      if (nestedSection.innerHTML === "") {
        Object.keys(course.weeks).forEach(week => {
          const weekCard = document.createElement("div");
          weekCard.className = "card p-2";
          weekCard.innerHTML = `
            <h6>Week ${week}</h6>
            <button class="btn btn-secondary btn-sm">Enter</button>
            <div class="nested-section" style="display: none;"></div>
          `;

          const weekToggle = weekCard.querySelector("button");
          const weekNested = weekCard.querySelector(".nested-section");

          weekToggle.addEventListener("click", () => {
            weekNested.style.display = weekNested.style.display === "none" ? "block" : "none";

            if (weekNested.innerHTML === "") {
              Object.entries(course.weeks[week]).forEach(([subjectName, data]) => {
                const types = [];
                if (data.mcq?.length) types.push("MCQ");
                if (data.fillBlanks?.length) types.push("Fill");
                if (data.trueFalse?.length) types.push("True/False");
                if (data.codeQuestions?.length) types.push("Code");

                const subjectCard = document.createElement("div");
                subjectCard.className = "card p-2";
                subjectCard.innerHTML = `
                  <h6>${subjectName}</h6>
                  <p><strong>Types:</strong> ${types.join(", ") || "None"}</p>
                  <button class="btn btn-outline-primary btn-sm" onclick="editAssignment('${data.docId}')">Edit</button>
                `;
                weekNested.appendChild(subjectCard);
              });
            }
          });

          nestedSection.appendChild(weekCard);
        });
      }
    });

    courseContainer.appendChild(courseCard);
  });
}


    // Global function so "onclick" works
    window.editAssignment = function (docId) {
      window.location.href = `create_assignment.html?editId=${docId}`;
    };

    loadAssignments();
  </script>
</body>
</html>
