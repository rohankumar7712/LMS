<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Assignment History</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    
    <!-- Custom CSS from the Admin Dashboard for a consistent UI -->
    <style>
        /* Google Font 'Inter' for a clean, modern look */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;700&display=swap');
        
        :root {
            --primary-bg: #E8F0F7; /* Soft Light Blue */
            --secondary-bg: #FFFFFF; /* White */
            --left-panel-bg: #2A5C88; /* Deep Blue */
            --card-bg: #FFFFFF; /* White */
            --accent-color: #4A90E2; /* Bright Light Blue */
            --text-light: #F7F7E8; /* Soft Cream */
            --text-dark: #2C3E50; /* Dark Gray-Blue */
            --input-border: #DDE0E3; /* Light Gray */
            --link-color: #4A90E2; /* Bright Light Blue */
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            background-color: var(--primary-bg);
        }
        
        .container-flex {
            display: flex;
            min-height: 100vh;
            overflow: hidden;
        }
        
        .sidebar {
            width: 250px;
            background-color: var(--left-panel-bg);
            color: var(--text-light);
            padding: 2rem 1.5rem;
            transition: transform 0.3s ease-in-out;
            transform: translateX(0);
            position: fixed;
            top: 0;
            bottom: 0;
            left: 0;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }
        
        .sidebar h4 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 2rem;
        }
        
        .sidebar a {
            color: var(--text-light);
            text-decoration: none;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.3s ease;
            font-weight: 400;
        }
        
        .sidebar a:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .sidebar a.active {
            background-color: var(--accent-color);
            color: var(--left-panel-bg);
            font-weight: 700;
        }
        
        .main-content {
            flex: 1;
            margin-left: 250px;
            padding: 2rem;
            transition: margin-left 0.3s ease-in-out;
        }

        .toggle-btn {
            position: fixed;
            top: 1rem;
            left: 1rem;
            background-color: var(--left-panel-bg);
            color: var(--text-light);
            border: none;
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            cursor: pointer;
            z-index: 1001;
            display: none; /* Hide on desktop */
        }

        .toggle-btn.hidden {
            display: none !important;
        }
        
        .sidebar.show {
            transform: translateX(0);
        }
        
        .card {
            border-radius: 1rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border: none;
            background-color: var(--card-bg);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
        }
        
        .card .btn-primary {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
            color: var(--left-panel-bg);
            font-weight: 700;
        }

        .card .btn-primary:hover {
            background-color: #3A7DC1;
            border-color: #3A7DC1;
        }

        .card .btn-secondary {
            background-color: var(--text-dark);
            border-color: var(--text-dark);
            color: var(--text-light);
        }

        .card .btn-secondary:hover {
            background-color: #4A5C6C;
            border-color: #4A5C6C;
        }
        
        .nested-section .card {
            box-shadow: none;
            border: 1px solid #e0e0e0;
        }
        
        .nested-section .card:hover {
            transform: none;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        
        /* Responsive styles for mobile */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.show {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .toggle-btn {
                display: block; /* Show the button on mobile */
            }
            
            .toggle-btn.hidden {
                display: none !important;
            }
        }
        
        /* Make the entire content scrollable on small screens */
        @media (max-width: 768px) {
            .container-flex {
                min-height: auto;
            }
            .main-content {
                padding-top: 5rem; /* Add space for the toggle button */
            }
        }
    </style>

</head>
<body>
    <div class="container-flex">
        <!-- Toggle button -->
        <button class="toggle-btn" onclick="toggleSidebar()">☰ Menu</button>
    
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <h4 class="mb-4">Admin Panel</h4>
            <a href="create_assignment.html">Create Assignment</a>
            <a href="create_Code_Assignment.html">Create Code Assignment</a>
            <a class="active" href="create_assignment_History.html">Assignment History</a>
            <a href="admin_dashboard.html">← Back</a>
        </div>
    
        <!-- Main content -->
        <div class="main-content p-3">
            <h2 class="mb-4">Assignment History</h2>
            <div id="courseContainer"></div>
        </div>
    </div>
    
    <!-- Status message -->
    <div id="statusMessage" class="alert" style="display:none;"></div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";
    
        const firebaseConfig = {
            apiKey: "AIzaSyD_C4ZPXTXQZtZJbtAwTiub_rkIZcvsE2Y",
            authDomain: "clms-19db3.firebaseapp.com",
            projectId: "clms-19db3",
            storageBucket: "clms-19db3.firebasestorage.app",
            messagingSenderId: "218119035486",
            appId: "1:218119035486:web:39291d39b4b461b56032cf"
        };
    
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
    
        const courseContainer = document.getElementById("courseContainer");
        const statusMessageDiv = document.getElementById("statusMessage");
    
        function showStatusMessage(message, type = 'info') {
            statusMessageDiv.textContent = message;
            statusMessageDiv.className = `alert mt-3 alert-${type}`;
            statusMessageDiv.style.display = 'block';
            setTimeout(() => { statusMessageDiv.style.display = 'none'; }, 3000);
        }
    
        async function loadAssignments() {
            try {
                const [coursesSnap, assignmentsSnap] = await Promise.all([
                    getDocs(collection(db, "courses")),
                    getDocs(collection(db, "assignments"))
                ]);
    
                const assignmentsByCourse = {};
    
                assignmentsSnap.forEach(doc => {
                    const data = doc.data();
                    const courseId = data.courseId;
                    const week = data.week || "Week Unknown";
                    const subject = data.subject || "Unknown Subject";
    
                    if (!assignmentsByCourse[courseId]) assignmentsByCourse[courseId] = { weeks: {} };
                    if (!assignmentsByCourse[courseId].weeks[week]) assignmentsByCourse[courseId].weeks[week] = {};
                    assignmentsByCourse[courseId].weeks[week][subject] = { ...data, docId: doc.id };
                });
    
                if (coursesSnap.empty && Object.keys(assignmentsByCourse).length === 0) {
                    courseContainer.innerHTML = "<p class='text-muted'>No assignments or courses found.</p>";
                    return;
                }
    
                coursesSnap.forEach(doc => {
                    const courseId = doc.id;
                    const data = doc.data();
    
                    const course = {
                        courseName: data.title || "Untitled Course",
                        startDate: data.startDate || "N/A",
                        endDate: data.endDate || "N/A",
                        weeks: assignmentsByCourse[courseId]?.weeks || {}
                    };
    
                    const courseCard = document.createElement("div");
                    courseCard.className = "card p-3 mb-3";
                    courseCard.innerHTML = `
                        <h5>${course.courseName}</h5>
                        <p><strong>Start:</strong> ${course.startDate} | <strong>End:</strong> ${course.endDate}</p>
                        <button class="btn btn-primary btn-sm">Enter</button>
                        <div class="nested-section mt-2" style="display: none;"></div>
                    `;
    
                    const toggleBtn = courseCard.querySelector("button");
                    const nestedSection = courseCard.querySelector(".nested-section");
    
                    toggleBtn.addEventListener("click", () => {
                        nestedSection.style.display = nestedSection.style.display === "none" ? "block" : "none";
    
                        if (nestedSection.innerHTML === "" && Object.keys(course.weeks).length) {
                            const sortedWeeks = Object.keys(course.weeks).sort((a, b) => {
                                const weekNumA = parseInt(a.replace(/\D/g, ''), 10) || 0;
                                const weekNumB = parseInt(b.replace(/\D/g, ''), 10) || 0;
                                return weekNumA - weekNumB;
                            });
    
                            sortedWeeks.forEach(week => {
                                const weekCard = document.createElement("div");
                                weekCard.className = "card p-2 mb-2";
                                weekCard.innerHTML = `
                                    <h6>${week}</h6>
                                    <button class="btn btn-secondary btn-sm">Enter</button>
                                    <div class="nested-section mt-2" style="display: none;"></div>
                                `;
    
                                const weekToggle = weekCard.querySelector("button");
                                const weekNested = weekCard.querySelector(".nested-section");
    
                                weekToggle.addEventListener("click", () => {
                                    weekNested.style.display = weekNested.style.display === "none" ? "block" : "none";
    
                                    if (weekNested.innerHTML === "") {
                                        Object.entries(course.weeks[week]).forEach(([subjectName, data]) => {
                                            const types = [];
                                            if (data.mcq?.length) types.push("MCQ");
                                            if (data.fillBlanks?.length) types.push("Fill");
                                            if (data.trueFalse?.length) types.push("True/False");
                                            if (data.codeQuestions?.length) types.push("Code");
    
                                            const subjectCard = document.createElement("div");
                                            subjectCard.className = "card p-2 mb-2";
                                            subjectCard.innerHTML = `
                                                <h6>${subjectName}</h6>
                                                <p><strong>Types:</strong> ${types.join(", ") || "None"}</p>
                                                <button class="btn btn-outline-primary btn-sm" onclick="editAssignment('${data.docId}')">Edit</button>
                                            `;
                                            weekNested.appendChild(subjectCard);
                                        });
                                    }
                                });
    
                                nestedSection.appendChild(weekCard);
                            });
                        }
                    });
    
                    courseContainer.appendChild(courseCard);
                });
            } catch (error) {
                console.error("Error loading assignments:", error);
                showStatusMessage("Error loading assignments: " + error.message, "danger");
            }
        }
    
        // Global edit function
        window.editAssignment = docId => {
            window.location.href = `create_assignment.html?editId=${docId}`;
        };
    
        // Sidebar toggle
        window.toggleSidebar = function () {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.querySelector('.main-content');
            const toggleBtn = document.querySelector('.toggle-btn');
            sidebar.classList.toggle('show');
            toggleBtn.classList.toggle('hidden', sidebar.classList.contains('show'));
        }

        window.addEventListener('load', loadAssignments);
    </script>
</body>
</html>
