<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Create Assignment</title>
    <!-- We're keeping Bootstrap for its grid system and form controls -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <style>
        /* Google Font 'Inter' for a clean, modern look */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;700&display=swap');
        
        :root {
            --primary-bg: #E8F0F7; /* Soft Light Blue */
            --secondary-bg: #FFFFFF; /* White */
            --left-panel-bg: #2A5C88; /* Deep Blue */
            --card-bg: #FFFFFF; /* White */
            --accent-color: #4A90E2; /* Bright Light Blue */
            --text-light: #F7F7E8; /* Soft Cream */
            --text-dark: #2C3E50; /* Dark Gray-Blue */
            --input-border: #DDE0E3; /* Light Gray */
            --link-color: #4A90E2; /* Bright Light Blue */
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            background-color: var(--primary-bg);
        }
        
        .container-flex {
            display: flex;
            min-height: 100vh;
            overflow: hidden;
        }
        
        .sidebar {
            width: 250px;
            background-color: var(--left-panel-bg);
            color: var(--text-light);
            padding: 2rem 1.5rem;
            transition: transform 0.3s ease-in-out;
            transform: translateX(0);
            position: fixed;
            top: 0;
            bottom: 0;
            left: 0;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }
        
        .sidebar h4 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 2rem;
        }
        
        .sidebar a {
            color: var(--text-light);
            text-decoration: none;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.3s ease;
            font-weight: 400;
        }
        
        .sidebar a:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .sidebar a.active {
            background-color: var(--accent-color);
            font-weight: 700;
        }
        
        .logout-link {
            margin-top: auto; /* Pushes the logout link to the bottom */
            background-color: var(--accent-color);
            color: var(--left-panel-bg);
            text-align: center;
            font-weight: 700;
        }
        
        .logout-link:hover {
            background-color: #3A7DC1;
            color: var(--text-light);
        }
        
        .main-content {
            flex: 1;
            margin-left: 250px;
            padding: 2rem;
            transition: margin-left 0.3s ease-in-out;
        }
        
        .dashboard-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-dark);
        }
        
        .card {
            border-radius: 1rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border: none;
            background-color: var(--card-bg);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
        }
        
        .card-title {
            color: var(--text-dark);
        }
        
        .toggle-btn {
            position: fixed;
            top: 1rem;
            left: 1rem;
            background-color: var(--left-panel-bg);
            color: var(--text-light);
            border: none;
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            cursor: pointer;
            z-index: 1001;
            display: none; /* Hide on desktop */
            transition: background-color 0.3s ease;
        }

        .toggle-btn:hover {
            background-color: #3A7DC1;
        }
        
        .toggle-btn.hidden {
            display: none !important;
        }

        /* --- NEW CUSTOM BUTTON STYLES TO MATCH THE UI --- */
        .custom-btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            border: none;
            cursor: pointer;
            font-weight: 700;
            transition: transform 0.2s ease, background-color 0.2s ease;
        }

        .custom-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .custom-btn-primary {
            background-color: var(--accent-color);
            color: var(--secondary-bg);
        }

        .custom-btn-primary:hover {
            background-color: #3A7DC1;
        }

        .custom-btn-secondary {
            background-color: var(--input-border);
            color: var(--text-dark);
        }
        
        .custom-btn-secondary:hover {
            background-color: #C3C5C8;
        }
        /* --- END OF NEW BUTTON STYLES --- */

        /* Responsive styles for mobile */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.show {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .toggle-btn {
                display: block;
            }
        }
        
        /* Make the entire content scrollable on small screens */
        @media (max-width: 768px) {
            .container-flex {
                min-height: auto;
            }
            .main-content {
                padding-top: 5rem; /* Add space for the toggle button */
            }
        }
    </style>

</head>

<body>
    <!-- Toggle button with a new ID -->
    <button id="toggleBtn" class="toggle-btn" onclick="toggleSidebar()">☰ Menu</button>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <h4 class="mb-4">Admin Panel</h4>
        <a class="active" href="create_assignment.html">Create Assignment</a>
        <a href="create_Code_Assignment.html">create code Assignment </a>
        <a href="create_assignment_History.html">Assignment History</a>
        <a href="admin_dashboard.html" onclick="logout()">← Back</a>
    </div>

    <div class="main-content">
        <h2 class="dashboard-title">Create Assignment</h2>

        <div class="form-container mb-4">
            <div class="mb-3">
                <label class="form-label">Select Course</label>
                <select class="form-select" id="courseSelect" required></select>
            </div>
            <div class="mb-3">
                <label class="form-label">Select Week</label>
                <select class="form-select" id="weekSelect" required></select>
            </div>
            <div class="mb-3">
                <label class="form-label">Select Subject</label>
                <select class="form-select" id="subjectSelect" required></select>
            </div>
        </div>

        <div class="form-container mb-4">
            <div class="row">
                <div class="col">
                    <label>Start Date</label>
                    <input type="datetime-local" class="form-control" id="startDate" />
                </div>
                <div class="col">
                    <label>End Date</label>
                    <input type="datetime-local" class="form-control" id="endDate" />
                </div>
            </div>
        </div>

        <div class="form-container mb-4">
            <h5>Manual Entry</h5>
            <div class="mb-3">
                <!-- Replaced btn-primary with custom-btn-primary -->
                <button class="custom-btn custom-btn-primary me-2" id="addQuestionBtn">Add Question</button>
                <!-- Replaced btn-success with custom-btn-primary -->
                <button class="custom-btn custom-btn-primary" id="saveQuizBtn">Save & Generate Code</button>
            </div>
            <div id="questions"></div>

            <hr />
            <h5>Text Format Input</h5>
            <textarea class="form-control mb-2" id="textFormatInput" rows="8" placeholder="Question: What is 2+2?
a) 2
b) 3
c) 4
d) 5
Answer: c
---
Question: Capital of France?
a) Berlin
b) Madrid
c) Rome
d) Paris
Answer: d"></textarea>
            <!-- Replaced btn-secondary with custom-btn-secondary -->
            <button class="custom-btn custom-btn-secondary" id="parseTextBtn">Parse Text</button>
            <p id="saveMsg" class="mt-2 text-success text-center"></p>
        </div>

        <!-- Replaced btn-info with custom-btn-primary -->
        <button class="custom-btn custom-btn-primary mt-3" onclick="saveFinalAssignment()">Save Final Assignment</button>

        <div id="successMsg" class="alert alert-success mt-3 d-none">Assignment saved!</div>
    </div>
    <!-- Custom Status Message -->
    <div id="statusMessage" class="alert"></div>

    <!-- Firebase Scripts -->
    <script type="module">
        import {
            initializeApp
        } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import {
            getFirestore,
            collection,
            setDoc,
            doc,
            getDoc,
            getDocs,
            addDoc
        } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

        const firebaseConfig = {
        apiKey: "AIzaSyD_C4ZPXTXQZtZJbtAwTiub_rkIZcvsE2Y",
        authDomain: "clms-19db3.firebaseapp.com",
        projectId: "clms-19db3",
        storageBucket: "clms-19db3.firebasestorage.app",
        messagingSenderId: "218119035486",
        appId: "1:218119035486:web:39291d39b4b461b56032cf"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const courseSelect = document.getElementById("courseSelect");
        const weekSelect = document.getElementById("weekSelect");
        const subjectSelect = document.getElementById("subjectSelect");
        const statusMessageDiv = document.getElementById("statusMessage");

        // Function to show custom status messages
        function showStatusMessage(message, type = 'info') {
            statusMessageDiv.textContent = message;
            statusMessageDiv.className = `alert mt-3 alert-${type}`;
            statusMessageDiv.style.display = 'block';
            setTimeout(() => {
                statusMessageDiv.style.display = 'none';
            }, 3000); // Hide after 3 seconds
        }

        async function loadCourses() {
            try {
                const snapshot = await getDocs(collection(db, "courses"));
                courseSelect.innerHTML = `<option value="">-- Select Course --</option>`;
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const option = document.createElement("option");
                    option.value = doc.id;
                    option.textContent = data.title;
                    courseSelect.appendChild(option);
                });
            } catch (error) {
                console.error("Error loading courses:", error);
                showStatusMessage("Error loading courses.", "danger");
            }
        }

        courseSelect.addEventListener("change", async () => {
            const courseId = courseSelect.value;
            if (!courseId) {
                weekSelect.innerHTML = `<option value="">-- Select Week --</option>`;
                subjectSelect.innerHTML = `<option value="">-- Select Subject --</option>`;
                return;
            }

            try {
                const courseDoc = await getDoc(doc(db, "courses", courseId));
                if (!courseDoc.exists()) {
                    console.warn("Course not found in Firestore");
                    showStatusMessage("Course not found.", "warning");
                    return;
                }

                const data = courseDoc.data();

                // Populate Weeks Dropdown (generate weeks from number)
                weekSelect.innerHTML = `<option value="">-- Select Week --</option>`;
                if (typeof data.weeks === 'number') {
                    for (let i = 1; i <= data.weeks; i++) {
                        const opt = document.createElement("option");
                        opt.value = `Week ${i}`;
                        opt.textContent = `Week ${i}`;
                        weekSelect.appendChild(opt);
                    }
                } else {
                    console.warn("Weeks not found or invalid");
                    showStatusMessage("Number of weeks not defined for this course.", "warning");
                }

                // Populate Subjects Dropdown
                subjectSelect.innerHTML = `<option value="">-- Select Subject --</option>`;
                if (Array.isArray(data.subjects)) {
                    data.subjects.forEach(subject => {
                        const opt = document.createElement("option");
                        opt.value = subject;
                        opt.textContent = subject;
                        subjectSelect.appendChild(opt);
                    });
                } else {
                    console.warn("Subjects not found or not in array format");
                    showStatusMessage("Subjects not defined for this course.", "warning");
                }
            } catch (error) {
                console.error("Error loading course data:", error);
                showStatusMessage("Error loading course data: " + error.message, "danger");
            }
        });
        weekSelect.addEventListener("change", () => {
    if (!courseStartDate || !courseEndDate) return;

    const selectedWeek = parseInt(weekSelect.value.replace("Week ", ""));
    if (isNaN(selectedWeek)) return;

    // Each week = 7 days
    const weekStart = new Date(courseStartDate);
    weekStart.setDate(courseStartDate.getDate() + (selectedWeek - 1) * 7);

    const weekEnd = new Date(weekStart);
    weekEnd.setDate(weekStart.getDate() + 6);

    // Prevent exceeding overall course end date
    if (weekEnd > courseEndDate) weekEnd.setTime(courseEndDate.getTime());

    // Set to datetime-local (need YYYY-MM-DDTHH:mm format)
    startDate.value = weekStart.toISOString().slice(0,16);
    endDate.value = weekEnd.toISOString().slice(0,16);
});


        // Question Handling
        const startDate = document.getElementById("startDate");
        const endDate = document.getElementById("endDate");
        const questionsDiv = document.getElementById("questions");
        const saveMsg = document.getElementById("saveMsg"); // This is for the Quiz code.
        const parseBtn = document.getElementById("parseTextBtn");
        const textInput = document.getElementById("textFormatInput");
        const addQBtn = document.getElementById("addQuestionBtn");
        const saveQBtn = document.getElementById("saveQuizBtn");

        let parsedQuestions = [];

        addQBtn.addEventListener("click", () => {
            parsedQuestions.push({
                question: '',
                a: '',
                b: '',
                c: '',
                d: '',
                correct: 'a',
                timeLimit: 30
            });
            renderQuestions();
        });

        function renderQuestions() {
            questionsDiv.innerHTML = '';
            parsedQuestions.forEach((q, idx) => {
                const card = document.createElement("div");
                card.className = "card mb-3 p-3";
                card.innerHTML = `
                    <label>Question ${idx + 1}</label>
                    <input type="text" class="form-control mb-2" placeholder="Enter question">
                    <input type="text" class="form-control mb-2" placeholder="Option A">
                    <input type="text" class="form-control mb-2" placeholder="Option B">
                    <input type="text" class="form-control mb-2" placeholder="Option C">
                    <input type="text" class="form-control mb-2" placeholder="Option D">
                    <label>Correct Option:</label>
                    <select class="form-select mb-2">
                        <option value="a">A</option>
                        <option value="b">B</option>
                        <option value="c">C</option>
                        <option value="d">D</option>
                    </select>
                    <label>Time Limit (seconds):</label>
                    <input type="number" class="form-control" value="30">
                `;
                const inputs = card.querySelectorAll("input, select");
                inputs[0].value = q.question;
                inputs[1].value = q.a;
                inputs[2].value = q.b;
                inputs[3].value = q.c;
                inputs[4].value = q.d;
                inputs[5].value = q.correct;
                inputs[6].value = q.timeLimit;

                inputs[0].addEventListener("input", e => q.question = e.target.value);
                inputs[1].addEventListener("input", e => q.a = e.target.value);
                inputs[2].addEventListener("input", e => q.b = e.target.value);
                inputs[3].addEventListener("input", e => q.c = e.target.value);
                inputs[4].addEventListener("input", e => q.d = e.target.value);
                inputs[5].addEventListener("change", e => q.correct = e.target.value);
                inputs[6].addEventListener("input", e => q.timeLimit = Number(e.target.value));

                questionsDiv.appendChild(card);
            });
        }

        parseBtn.addEventListener("click", () => {
            const inputText = textInput.value.trim();
            const blocks = inputText.split(/\n\s*\n(?=Question:)/).map(b => b.trim()).filter(b => b); // Split by "---"
            parsedQuestions = [];

            blocks.forEach(block => {
                const lines = block.split("\n").map(line => line.trim()).filter(line => line);
                if (lines.length < 3) return;

                const questionLine = lines.find(l => /^Question:\s*/i.test(l));
                if (!questionLine) return; // Skip if no question line found

                const questionText = questionLine.replace(/^Question:\s*/i, "");
                const options = { a: "", b: "", c: "", d: "" };
                let correct = "a";

                const answerLine = lines.find(l => /^Answer:\s*/i.test(l));
                if (answerLine) correct = answerLine.replace(/^Answer:\s*/i, "").trim().toLowerCase();

                lines.forEach(line => {
                    if (/^a\)/i.test(line)) options.a = line.replace(/^a\)\s*/i, "");
                    else if (/^b\)/i.test(line)) options.b = line.replace(/^b\)\s*/i, "");
                    else if (/^c\)/i.test(line)) options.c = line.replace(/^c\)\s*/i, "");
                    else if (/^d\)/i.test(line)) options.d = line.replace(/^d\)\s*/i, "");
                });

                const isTF = options.a.toLowerCase() === "true" && options.b.toLowerCase() === "false" && !options.c && !options.d;
                const isFill = questionText.includes("___");

                parsedQuestions.push({
                    question: questionText,
                    a: options.a,
                    b: options.b,
                    c: options.c,
                    d: options.d,
                    correct,
                    timeLimit: isTF ? 10 : isFill ? 15 : 20,
                    type: isTF ? "truefalse" : isFill ? "fillblank" : "mcq"
                });
            });

            if (parsedQuestions.length === 0) {
                showStatusMessage("No valid questions found. Check your format.", "warning");
            } else {
                renderQuestions();
                showStatusMessage(`${parsedQuestions.length} questions parsed successfully.`, "success");
            }
        });

        function generateQuizCode(length = 6) {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            return Array.from({ length }, () => chars[Math.floor(Math.random() * chars.length)]).join('');
        }

        saveQBtn.addEventListener("click", async () => {
            if (!startDate.value || !endDate.value || parsedQuestions.length === 0) {
                showStatusMessage("Please fill all fields and add at least one question.", "warning");
                return;
            }
            if (!courseSelect.value || !weekSelect.value || !subjectSelect.value) {
                showStatusMessage("Please select course, week, and subject before saving quiz.", "warning");
                return;
            }

            const quizCode = generateQuizCode();

            const quiz = {
                quizCode,
                startAt: startDate.value,
                endAt: endDate.value,
                course: courseSelect.value,
                week: weekSelect.value,
                subject: subjectSelect.value,
                questions: parsedQuestions,
                createdAt: new Date().toISOString()
            };

            try {
                await setDoc(doc(db, "quizzes", quizCode), quiz);
                saveMsg.textContent = `Quiz saved successfully! Code: ${quizCode}`;
                showStatusMessage(`Quiz saved successfully! Code: ${quizCode}`, "success");
                setTimeout(() => window.location.reload(), 2000); // Reload after showing message
            } catch (err) {
                console.error(err);
                showStatusMessage("Error saving quiz! " + err.message, "danger");
            }
        });

        window.saveFinalAssignment = async function () {
            const courseId = courseSelect.value;
            const week = weekSelect.value;
            const subject = subjectSelect.value;

            if (!courseId || !week || !subject) {
                showStatusMessage("Please select course, week, and subject.", "warning");
                return;
            }

            if (parsedQuestions.length === 0) {
                showStatusMessage("No questions to save. Please parse or add questions.", "warning");
                return;
            }

            const assignmentData = {
                courseId,
                week,
                subject,
                mcq: parsedQuestions.filter(q => q.type === "mcq"),
                fillBlanks: parsedQuestions.filter(q => q.type === "fillblank"),
                trueFalse: parsedQuestions.filter(q => q.type === "truefalse"),
                codeQuestions: [], // Assuming code questions are handled separately or added here manually
                createdAt: new Date().toISOString()
            };

            try {
                await addDoc(collection(db, "assignments"), assignmentData);
                showStatusMessage("Assignment saved successfully!", "success");
                setTimeout(() => window.location.reload(), 2000); // Reload after showing message
            } catch (err) {
                console.error("Error saving assignment:", err);
                showStatusMessage("Failed to save assignment. " + err.message, "danger");
            }
        };

        // Sidebar toggle function for mobile
        window.toggleSidebar = function () {
            const sidebar = document.getElementById('sidebar');
            const toggleBtn = document.getElementById('toggleBtn');
            
            sidebar.classList.toggle('show');

            // Hide the button when the menu is open, show it when it's closed
            if (sidebar.classList.contains('show')) {
                toggleBtn.style.display = 'none';
            } else {
                // We use 'block' to make it visible, relying on the media query to handle the initial state.
                toggleBtn.style.display = 'block';
            }
        }

        window.logout = function () {
            window.location.href = "../index.html";
        }

        window.onload = loadCourses;
    </script>
</body>
</html>
