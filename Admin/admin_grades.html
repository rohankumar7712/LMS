<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Admin - All Grades</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            background: #f5f9f8;
            font-family: 'Inter', sans-serif;
            margin: 0;
            display: flex; /* Enables side-by-side layout for sidebar and main content */
        }

        /* Sidebar */
        .sidebar {
            min-height: 100vh;
            background-color: #2A5C88;
            color: white;
            padding: 20px 10px;
            transition: left 0.3s ease-in-out;
            z-index: 1001;
            position: fixed; /* Keep position fixed */
            top: 0;
            left: 0;
            width: 220px;
        }

        .sidebar h4 {
            font-weight: bold;
            margin-bottom: 30px;
        }

        .sidebar a {
            color: white;
            text-decoration: none;
            display: block;
            padding: 10px;
            border-radius: 8px;
            transition: background-color 0.3s ease;
            cursor: pointer;
        }

        .sidebar a:hover,
        .sidebar a.active {
            background-color: #204664;
        }

        .sidebar a.logout-link {
            color: #ffcccc !important;
        }

        .sidebar a.logout-link:hover {
            background-color: #c0392b;
            color: white !important;
        }

        /* Toggle Button */
        .toggle-btn {
            display: none;
            background-color: #2A5C88;
            color: white;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 5px;
            font-size: 16px;
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 1002;
        }

        /* Main Content */
        .main-content {
            flex-grow: 1;
            padding: 20px;
            margin-left: 0; /* Default for mobile, will be overridden by desktop layout */
        }

        /* Grades Table Styling */
        .grades-table {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            overflow-x: auto; /* For responsive table on small screens */
        }
        .grades-table table {
            width: 100%;
            margin-bottom: 0;
            border-collapse: collapse;
        }
        .grades-table th, .grades-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        .grades-table th {
            background-color: #2A5C88;
            color: white;
            font-weight: 600;
            position: sticky; /* Make header sticky for scrollable tables */
            top: 0;
            z-index: 1;
        }
        .grades-table tbody tr:hover {
            background-color: #f0f0f0;
        }
        .grades-table tbody tr:last-child td {
            border-bottom: none;
        }
        .grades-table .score-good {
            color: #28a745; /* Green for good scores */
            font-weight: 600;
        }
        .grades-table .score-average {
            color: #ffc107; /* Orange for average scores */
            font-weight: 600;
        }
        .grades-table .score-low {
            color: #dc3545; /* Red for low scores */
            font-weight: 600;
        }


        /* Status message styling */
        #statusMessage {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1050; /* Ensure it's above other content */
            width: auto;
            min-width: 300px;
            text-align: center;
            padding: 10px 20px;
            border-radius: 8px;
            display: none; /* Hidden by default */
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        /* Overlay for mobile menu */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5); /* Semi-transparent black */
            z-index: 1000; /* Behind the sidebar, but above everything else */
            display: none; /* Hidden by default */
        }

        /* Mobile Layout */
        @media (max-width: 768px) {
            body {
                display: block; /* Stack sidebar and main content vertically on mobile */
            }
            .sidebar {
                width: 220px;
                left: -220px; /* Hide the sidebar off-screen */
                position: fixed;
                top: 0;
            }

            .sidebar.show {
                left: 0; /* Slide in from the left */
            }

            .toggle-btn {
                display: block;
            }

            .main-content {
                margin-left: 0; /* Full width on mobile */
                padding-top: 60px; /* Add padding to prevent content from going under the fixed toggle button */
            }
        }

        /* Desktop Layout */
        @media (min-width: 769px) {
            .sidebar {
                position: fixed; /* Keep it fixed on desktop */
                left: 0; /* Always visible */
                width: 220px;
                transform: none;
            }
            
            .main-content {
                margin-left: 220px; /* Space for the fixed sidebar */
                padding: 20px;
            }
            
            .toggle-btn {
                display: none;
            }

            .overlay {
                display: none !important;
            }
        }
    </style>
</head>
<body>

<button class="toggle-btn" onclick="toggleSidebar()">â˜° Menu</button>

<div class="overlay" onclick="toggleSidebar()"></div>

<div class="sidebar" id="sidebar">
    <h4 class="mb-4">Admin Panel</h4>
    <a href="#" class="active">All Grades</a>
    <a href="admin_dashboard.html">back</a>
</div>

<div class="main-content">
    <h2 class="dashboard-title">All Student Grades</h2>
    <div class="mb-4">
        <label for="filterStudent" class="form-label">Filter by Student ID/Name:</label>
        <input type="text" id="filterStudent" class="form-control" placeholder="Enter student ID or name">
    </div>
    <div class="mb-4">
        <label for="filterCourse" class="form-label">Filter by Course:</label>
        <input type="text" id="filterCourse" class="form-control" placeholder="Enter course title or ID">
    </div>
    <div class="mb-4">
        <label for="filterSubject" class="form-label">Filter by Subject:</label>
        <input type="text" id="filterSubject" class="form-control" placeholder="Enter subject name">
    </div>
    <div class="mb-4">
        <label for="filterWeek" class="form-label">Filter by Week:</label>
        <input type="number" id="filterWeek" class="form-control" placeholder="Enter week number">
    </div>
    
    <div id="gradesTableContainer" class="grades-table mt-4">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>Student ID</th>
                    <th>Student Name</th>
                    <th>Type</th>
                    <th>Course</th>
                    <th>Week</th>
                    <th>Subject</th>
                    <th>Assignment ID</th>
                    <th>Score</th>
                    <th>Max Score</th>
                    <th>Percentage (%)</th>
                    <th>Submitted At</th>
                </tr>
            </thead>
            <tbody id="gradesTableBody">
                <tr><td colspan="11" class="text-center">Loading grades...</td></tr>
            </tbody>
        </table>
    </div>
    <p id="noGradesMessage" class="text-center mt-3" style="display:none;">No grades found matching your filters.</p>
</div>

<div id="statusMessage" class="alert"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyD_C4ZPXTXQZtZJbtAwTiub_rkIZcvsE2Y",
        authDomain: "clms-19db3.firebaseapp.com",
        projectId: "clms-19db3",
        storageBucket: "clms-19db3.firebasestorage.app",
        messagingSenderId: "218119035486",
        appId: "1:218119035486:web:39291d39b4b461b56032cf"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const gradesTableBody = document.getElementById("gradesTableBody");
    const noGradesMessage = document.getElementById("noGradesMessage");
    const statusMessageDiv = document.getElementById("statusMessage");

    // Filter elements
    const filterStudent = document.getElementById("filterStudent");
    const filterCourse = document.getElementById("filterCourse");
    const filterSubject = document.getElementById("filterSubject");
    const filterWeek = document.getElementById("filterWeek");

    let allSubmissions = []; // Store all fetched submissions for client-side filtering

    // Function to display custom status messages
    function showStatusMessage(message, type = 'info') {
        statusMessageDiv.textContent = message;
        statusMessageDiv.className = `alert alert-${type}`;
        statusMessageDiv.style.display = 'block';
        setTimeout(() => {
            statusMessageDiv.style.display = 'none';
        }, 3000); // Hide after 3 seconds
    }

    // IMPORTANT: Client-side check removed. Access is now solely controlled by Firestore Security Rules.
    // Ensure your Firebase Security Rules grant read access to both 'submissions' and 'code_submission'
    // ONLY for authenticated admins with 'admin: true' custom claims.
    async function loadAllGrades() {
        gradesTableBody.innerHTML = '<tr><td colspan="11" class="text-center">Loading grades...</td></tr>';
        noGradesMessage.style.display = 'none';
        allSubmissions = []; // Clear previous data

        try {
            // Fetch from 'submissions' (regular assignments)
            const regularSubmissionsSnapshot = await getDocs(collection(db, "submissions"));
            regularSubmissionsSnapshot.forEach(doc => {
                const data = doc.data();
                if (data.score !== undefined && data.maxScore !== undefined && data.percentage !== undefined) {
                    allSubmissions.push({
                        ...data,
                        type: 'Regular', // Add type field
                        overallScore: data.score, // Map to overall for consistency
                        overallMaxScore: data.maxScore, // Map to overall for consistency
                        overallPercentage: data.percentage // Map to overall for consistency
                    });
                }
            });

            // Fetch from 'code_submission' (code assignments)
            const codeSubmissionsSnapshot = await getDocs(collection(db, "code_submission"));
            codeSubmissionsSnapshot.forEach(doc => {
                const data = doc.data();
                if (data.overallScore !== undefined && data.overallMaxScore !== undefined && data.overallPercentage !== undefined) {
                    allSubmissions.push({
                        ...data,
                        type: 'Code' // Add type field
                    });
                }
            });

            // Sort all submissions by submittedAt timestamp (most recent first)
            allSubmissions.sort((a, b) => {
                const dateA = a.submittedAt.toDate ? a.submittedAt.toDate() : (a.submittedAt ? new Date(a.submittedAt) : new Date(0));
                const dateB = b.submittedAt.toDate ? b.submittedAt.toDate() : (b.submittedAt ? new Date(b.submittedAt) : new Date(0));
                return dateB - dateA; // Descending order
            });

            renderGradesTable(allSubmissions);

        } catch (error) {
            console.error("Error loading all grades:", error);
            gradesTableBody.innerHTML = '<tr><td colspan="11" class="text-center text-danger">Error loading grades. Access Denied (Check Firebase Security Rules).</td></tr>';
            showStatusMessage("Error loading grades: " + error.message + ". Access likely denied by Security Rules.", "danger");
        }
    }

    function renderGradesTable(gradesToDisplay) {
        gradesTableBody.innerHTML = '';
        if (gradesToDisplay.length === 0) {
            noGradesMessage.style.display = 'block';
            return;
        }
        noGradesMessage.style.display = 'none';

        gradesToDisplay.forEach(grade => {
            const row = document.createElement("tr");

            let percentageClass = '';
            if (grade.overallPercentage >= 80) { 
                percentageClass = 'score-good';
            } else if (grade.overallPercentage >= 50) {
                percentageClass = 'score-average';
            } else {
                percentageClass = 'score-low';
            }

            const submittedDate = grade.submittedAt && grade.submittedAt.toDate ? grade.submittedAt.toDate() : new Date(grade.submittedAt);
            
            // Format week number: extract only the number if it's "Week X"
            let formattedWeek = grade.week || 'N/A';
            if (grade.type === 'Regular' && typeof grade.week === 'string' && grade.week.startsWith('Week ')) {
                formattedWeek = grade.week.replace('Week ', '');
            }


            row.innerHTML = `
                <td>${grade.studentId || 'N/A'}</td>
                <td>${grade.studentName || 'N/A'}</td>
                <td>${grade.type || 'N/A'}</td>
                <td>${grade.courseId || 'N/A'}</td>
                <td>${formattedWeek}</td>
                <td>${grade.subject || 'N/A'}</td>
                <td>${grade.assignmentId || 'N/A'}</td>
                <td>${grade.overallScore || 0}</td>
                <td>${grade.overallMaxScore || 0}</td>
                <td class="${percentageClass}">${(grade.overallPercentage || 0).toFixed(2)}</td>
                <td>${submittedDate.toLocaleString() || 'N/A'}</td>
            `;
            gradesTableBody.appendChild(row);
        });
    }

    function applyFilters() {
        const studentFilter = filterStudent.value.toLowerCase();
        const courseFilter = filterCourse.value.toLowerCase();
        const subjectFilter = filterSubject.value.toLowerCase();
        const weekFilter = filterWeek.value ? parseInt(filterWeek.value) : null;

        const filteredGrades = allSubmissions.filter(grade => {
            const matchesStudent = !studentFilter || 
                                     (grade.studentId && grade.studentId.toLowerCase().includes(studentFilter)) ||
                                     (grade.studentName && grade.studentName.toLowerCase().includes(studentFilter));
            const matchesCourse = !courseFilter || (grade.courseId && grade.courseId.toLowerCase().includes(courseFilter));
            const matchesSubject = !subjectFilter || (grade.subject && grade.subject.toLowerCase().includes(subjectFilter));
            
            let gradeWeekValue = grade.week;
            if (grade.type === 'Regular' && typeof gradeWeekValue === 'string' && gradeWeekValue.startsWith('Week ')) {
                gradeWeekValue = parseInt(gradeWeekValue.replace('Week ', ''), 10);
            }

            const matchesWeek = weekFilter === null || (gradeWeekValue == weekFilter); /* Use == for flexible comparison */

            return matchesStudent && matchesCourse && matchesSubject && matchesWeek;
        });
        renderGradesTable(filteredGrades);
    }

    // Add event listeners for filters
    filterStudent.addEventListener('input', applyFilters);
    filterCourse.addEventListener('input', applyFilters);
    filterSubject.addEventListener('input', applyFilters);
    filterWeek.addEventListener('input', applyFilters);

    // Initial load
    loadAllGrades();

    // Sidebar toggle function for mobile
    window.toggleSidebar = function () {
        const sidebar = document.getElementById("sidebar");
        const overlay = document.querySelector(".overlay");
        if (sidebar && overlay) {
            sidebar.classList.toggle('show');
            if (sidebar.classList.contains('show')) {
                overlay.style.display = 'block';
            } else {
                overlay.style.display = 'none';
            }
        }
    }

    window.logout = () => {
        localStorage.removeItem("student"); 
        location.href = "../index.html"; 
    };
</script>
</body>
</html>