<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Admin - All Grades</title>
    <!-- Using Tailwind CSS for a modern, utility-first approach -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Google Font 'Inter' for a clean, modern look */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;700&display=swap');
        
        :root {
            --primary-bg: #E8F0F7; /* Soft Light Blue */
            --secondary-bg: #FFFFFF; /* White */
            --left-panel-bg: #2A5C88; /* Deep Blue */
            --card-bg: #FFFFFF; /* White */
            --accent-color: #4A90E2; /* Bright Light Blue */
            --text-light: #F7F7E8; /* Soft Cream */
            --text-dark: #2C3E50; /* Dark Gray-Blue */
            --input-border: #DDE0E3; /* Light Gray */
            --link-color: #4A90E2; /* Bright Light Blue */
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            background-color: var(--primary-bg);
        }
        
        .container-flex {
            display: flex;
            min-height: 100vh;
            overflow: hidden;
        }
        
        .sidebar {
            width: 250px;
            background-color: var(--left-panel-bg);
            color: var(--text-light);
            padding: 2rem 1.5rem;
            transition: transform 0.3s ease-in-out;
            transform: translateX(0);
            position: fixed;
            top: 0;
            bottom: 0;
            left: 0;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }
        
        .sidebar h4 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 2rem;
        }
        
        .sidebar a {
            color: var(--text-light);
            text-decoration: none;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.3s ease;
            font-weight: 400;
        }
        
        .sidebar a:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .sidebar a.active {
            background-color: var(--accent-color);
            font-weight: 700;
        }
        
        .logout-link {
            margin-top: auto; /* Pushes the logout link to the bottom */
            background-color: var(--accent-color);
            color: var(--left-panel-bg);
            text-align: center;
            font-weight: 700;
        }
        
        .logout-link:hover {
            background-color: #3A7DC1;
            color: var(--text-light);
        }
        
        .main-content {
            flex: 1;
            margin-left: 250px;
            padding: 2rem;
            transition: margin-left 0.3s ease-in-out;
        }
        
        .dashboard-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-dark);
        }
        
        .card {
            border-radius: 1rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border: none;
            background-color: var(--card-bg);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
        }
        
        .card-title {
            color: var(--text-dark);
        }
        
        .toggle-btn {
            position: fixed;
            top: 1rem;
            left: 1rem;
            background-color: var(--left-panel-bg);
            color: var(--text-light);
            border: none;
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            cursor: pointer;
            z-index: 1001;
            display: none; /* Hide on desktop */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: opacity 0.3s ease;
        }
        
        .toggle-btn.hidden {
            display: none !important;
        }

        /* Custom styles for the grades table */
        .grades-table table {
            border-collapse: separate;
            border-spacing: 0;
            overflow: hidden;
            border-radius: 1rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .grades-table th {
            background-color: #4A90E2; /* Use the accent color for headers */
            color: white;
            font-weight: 600;
            text-align: left;
            padding: 1rem;
        }

        .grades-table td {
            background-color: #FFFFFF; /* White background for data cells */
            padding: 1rem;
            border-bottom: 1px solid #E8F0F7; /* Light border between rows */
        }
        
        .grades-table tr:hover td {
            background-color: #F0F8FF; /* Light hover effect */
        }

        /* Specific styling for the score percentage */
        .score-good {
            color: #1a8f1a; /* Green for good scores */
            font-weight: 600;
        }

        .score-average {
            color: #d19520; /* Orange/Yellow for average scores */
            font-weight: 600;
        }

        .score-low {
            color: #C0392B; /* Red for low scores */
            font-weight: 600;
        }
       /* Custom styles for the grades table */
/* Custom styles for the grades table */
.grades-table .overflow-x-auto {
    /* Remove overflow-x: auto as we no longer want scrolling */
    overflow-x: hidden;
}

.grades-table table {
    width: 100%; /* Force table to take up the full width of its container */
    table-layout: fixed; /* Crucial: This makes all columns a fixed size and helps prevent horizontal overflow */
    border-collapse: separate;
    border-spacing: 0;
    border-radius: 1rem;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
}

.grades-table th, 
.grades-table td {
    /* Allow text to wrap to a new line */
    white-space: normal;
    word-wrap: break-word; /* Prevents long words from breaking the layout */
    padding: 1rem;
}

/* Optional: You can make specific columns narrower if needed */
.grades-table td:nth-child(1), /* Student ID */
.grades-table td:nth-child(5) { /* Week */
    width: 10%; 
}

.grades-table td:nth-child(8), /* Score */
.grades-table td:nth-child(9), /* Max Score */
.grades-table td:nth-child(10) { /* Percentage */
    width: 8%;
}


        /* Responsive styles for mobile */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.show {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .toggle-btn {
                display: block;
            }

            .grades-table table {
                font-size: 0.8rem;
                table-layout: fixed;
                width: 100%;
            }

            .grades-table th, .grades-table td {
                padding: 0.5rem;
            }
            
            .container-flex {
                min-height: auto;
            }
            
            .main-content {
                padding-top: 5rem; /* Add space for the toggle button */
            }
        }

    </style>
</head>
<body>
<div class="container-flex">
<button class="toggle-btn">â˜° Menu</button>
<div class="overlay"></div>

<div class="sidebar" id="sidebar">
    <h4>Admin Panel</h4>
    <a href="admin_dashboard.html" >Dashboard</a>
    <a href="admin_courses.html">Courses</a>
    <a href="create_assignment.html">Assignment</a>
    <a href="upload_material.html">Upload Material</a>
    <a href="student.html">Students</a>
    <a href="admin_grades.html" class="active">Grades</a>
    <a href="../index.html" class="logout-link" onclick="logout()">Logout</a>
</div>

<div class="main-content">
    <h2 class="dashboard-title">All Student Grades</h2>
    
    <!-- Filter inputs now use Tailwind classes for a cleaner look -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
        <div>
            <label for="filterStudent" class="block text-sm font-medium text-gray-700 mb-1">Filter by Student ID/Name:</label>
            <input type="text" id="filterStudent" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-accent-color" placeholder="Enter student ID or name">
        </div>
        <div>
            <label for="filterCourse" class="block text-sm font-medium text-gray-700 mb-1">Filter by Course:</label>
            <input type="text" id="filterCourse" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-accent-color" placeholder="Enter course title or ID">
        </div>
        <div>
            <label for="filterSubject" class="block text-sm font-medium text-gray-700 mb-1">Filter by Subject:</label>
            <input type="text" id="filterSubject" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-accent-color" placeholder="Enter subject name">
        </div>
        <div>
            <label for="filterWeek" class="block text-sm font-medium text-gray-700 mb-1">Filter by Week:</label>
            <input type="number" id="filterWeek" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-accent-color" placeholder="Enter week number">
        </div>
    </div>
    
    <div id="gradesTableContainer" class="grades-table mt-4">
    <div class="overflow-x-auto">
        <table class="min-w-full">
            <thead>
                <tr>
                    <th>Student ID</th>
                    <th>Student Name</th>
                    <th>Type</th>
                    <th>Course</th>
                    <th>Week</th>
                    <th>Subject</th>
                    <th>Assignment ID</th>
                    <th>Score</th>
                    <th>Max Score</th>
                    <th>Percentage (%)</th>
                    <th>Submitted At</th>
                </tr>
            </thead>
            <tbody id="gradesTableBody">
                <tr><td colspan="11" class="text-center text-gray-500">Loading grades...</td></tr>
            </tbody>
        </table>
    </div>
</div>

    <p id="noGradesMessage" class="text-center text-gray-500 mt-3" style="display:none;">No grades found matching your filters.</p>
</div>
</div>


<div id="statusMessage" class="alert"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyD_C4ZPXTXQZtZJbtAwTiub_rkIZcvsE2Y",
        authDomain: "clms-19db3.firebaseapp.com",
        projectId: "clms-19db3",
        storageBucket: "clms-19db3.firebasestorage.app",
        messagingSenderId: "218119035486",
        appId: "1:218119035486:web:39291d39b4b461b56032cf"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const gradesTableBody = document.getElementById("gradesTableBody");
    const noGradesMessage = document.getElementById("noGradesMessage");
    const statusMessageDiv = document.getElementById("statusMessage");

    // Filter elements
    const filterStudent = document.getElementById("filterStudent");
    const filterCourse = document.getElementById("filterCourse");
    const filterSubject = document.getElementById("filterSubject");
    const filterWeek = document.getElementById("filterWeek");

    let allSubmissions = []; // Store all fetched submissions for client-side filtering

    // Function to display custom status messages
    function showStatusMessage(message, type = 'info') {
        const typeClasses = {
            info: 'bg-blue-100 text-blue-800',
            danger: 'bg-red-100 text-red-800'
        };
        statusMessageDiv.textContent = message;
        statusMessageDiv.className = `fixed bottom-4 left-1/2 -translate-x-1/2 p-4 rounded-lg shadow-lg z-50 ${typeClasses[type]}`;
        statusMessageDiv.style.display = 'block';
        setTimeout(() => {
            statusMessageDiv.style.display = 'none';
        }, 3000); // Hide after 3 seconds
    }

    // IMPORTANT: Client-side check removed. Access is now solely controlled by Firestore Security Rules.
    // Ensure your Firebase Security Rules grant read access to both 'submissions' and 'code_submission'
    // ONLY for authenticated admins with 'admin: true' custom claims.
    async function loadAllGrades() {
        gradesTableBody.innerHTML = '<tr><td colspan="11" class="text-center text-gray-500">Loading grades...</td></tr>';
        noGradesMessage.style.display = 'none';
        allSubmissions = []; // Clear previous data

        try {
            // Fetch from 'submissions' (regular assignments)
            const regularSubmissionsSnapshot = await getDocs(collection(db, "submissions"));
            regularSubmissionsSnapshot.forEach(doc => {
                const data = doc.data();
                if (data.score !== undefined && data.maxScore !== undefined && data.percentage !== undefined) {
                    allSubmissions.push({
                        ...data,
                        type: 'Regular', // Add type field
                        overallScore: data.score, // Map to overall for consistency
                        overallMaxScore: data.maxScore, // Map to overall for consistency
                        overallPercentage: data.percentage // Map to overall for consistency
                    });
                }
            });

            // Fetch from 'code_submission' (code assignments)
            const codeSubmissionsSnapshot = await getDocs(collection(db, "code_submission"));
            codeSubmissionsSnapshot.forEach(doc => {
                const data = doc.data();
                if (data.overallScore !== undefined && data.overallMaxScore !== undefined && data.overallPercentage !== undefined) {
                    allSubmissions.push({
                        ...data,
                        type: 'Code' // Add type field
                    });
                }
            });

            // Sort all submissions by submittedAt timestamp (most recent first)
            allSubmissions.sort((a, b) => {
                const dateA = a.submittedAt.toDate ? a.submittedAt.toDate() : (a.submittedAt ? new Date(a.submittedAt) : new Date(0));
                const dateB = b.submittedAt.toDate ? b.submittedAt.toDate() : (b.submittedAt ? new Date(b.submittedAt) : new Date(0));
                return dateB - dateA; // Descending order
            });

            renderGradesTable(allSubmissions);

        } catch (error) {
            console.error("Error loading all grades:", error);
            gradesTableBody.innerHTML = '<tr><td colspan="11" class="text-center text-red-500">Error loading grades. Access Denied (Check Firebase Security Rules).</td></tr>';
            showStatusMessage("Error loading grades: " + error.message + ". Access likely denied by Security Rules.", "danger");
        }
    }

    function renderGradesTable(gradesToDisplay) {
        gradesTableBody.innerHTML = '';
        if (gradesToDisplay.length === 0) {
            noGradesMessage.style.display = 'block';
            return;
        }
        noGradesMessage.style.display = 'none';

        gradesToDisplay.forEach(grade => {
            const row = document.createElement("tr");

            let percentageClass = '';
            if (grade.overallPercentage >= 80) { 
                percentageClass = 'score-good';
            } else if (grade.overallPercentage >= 50) {
                percentageClass = 'score-average';
            } else {
                percentageClass = 'score-low';
            }

            const submittedDate = grade.submittedAt && grade.submittedAt.toDate ? grade.submittedAt.toDate() : new Date(grade.submittedAt);
            
            // Format week number: extract only the number if it's "Week X"
            let formattedWeek = grade.week || 'N/A';
            if (grade.type === 'Regular' && typeof grade.week === 'string' && grade.week.startsWith('Week ')) {
                formattedWeek = grade.week.replace('Week ', '');
            }

            row.innerHTML = `
                <td>${grade.studentId || 'N/A'}</td>
                <td>${grade.studentName || 'N/A'}</td>
                <td>${grade.type || 'N/A'}</td>
                <td>${grade.courseId || 'N/A'}</td>
                <td>${formattedWeek}</td>
                <td>${grade.subject || 'N/A'}</td>
                <td>${grade.assignmentId || 'N/A'}</td>
                <td>${grade.overallScore || 0}</td>
                <td>${grade.overallMaxScore || 0}</td>
                <td class="${percentageClass}">${(grade.overallPercentage || 0).toFixed(2)}</td>
                <td>${submittedDate.toLocaleString() || 'N/A'}</td>
            `;
            gradesTableBody.appendChild(row);
        });
    }

    function applyFilters() {
        const studentFilter = filterStudent.value.toLowerCase();
        const courseFilter = filterCourse.value.toLowerCase();
        const subjectFilter = filterSubject.value.toLowerCase();
        const weekFilter = filterWeek.value ? parseInt(filterWeek.value) : null;

        const filteredGrades = allSubmissions.filter(grade => {
            const matchesStudent = !studentFilter || 
                                    (grade.studentId && grade.studentId.toLowerCase().includes(studentFilter)) ||
                                    (grade.studentName && grade.studentName.toLowerCase().includes(studentFilter));
            const matchesCourse = !courseFilter || (grade.courseId && grade.courseId.toLowerCase().includes(courseFilter));
            const matchesSubject = !subjectFilter || (grade.subject && grade.subject.toLowerCase().includes(subjectFilter));
            
            let gradeWeekValue = grade.week;
            if (grade.type === 'Regular' && typeof gradeWeekValue === 'string' && gradeWeekValue.startsWith('Week ')) {
                gradeWeekValue = parseInt(gradeWeekValue.replace('Week ', ''), 10);
            }

            const matchesWeek = weekFilter === null || (gradeWeekValue == weekFilter); /* Use == for flexible comparison */

            return matchesStudent && matchesCourse && matchesSubject && matchesWeek;
        });
        renderGradesTable(filteredGrades);
    }

    // Add event listeners for filters
    filterStudent.addEventListener('input', applyFilters);
    filterCourse.addEventListener('input', applyFilters);
    filterSubject.addEventListener('input', applyFilters);
    filterWeek.addEventListener('input', applyFilters);

    // Initial load
    loadAllGrades();

    // Attach event listeners for the sidebar toggle
    document.querySelector('.toggle-btn').addEventListener('click', () => {
        toggleSidebar();
    });

    document.querySelector('.overlay').addEventListener('click', () => {
        toggleSidebar();
    });

    // Sidebar toggle function for mobile
    window.toggleSidebar = function () {
        const sidebar = document.getElementById("sidebar");
        const overlay = document.querySelector(".overlay");
        const toggleBtn = document.querySelector(".toggle-btn");
        if (sidebar && overlay) {
            sidebar.classList.toggle('show');
            toggleBtn.classList.toggle('hidden');
            if (sidebar.classList.contains('show')) {
                overlay.style.display = 'block';
            } else {
                overlay.style.display = 'none';
            }
        }
    }

    window.logout = () => {
        localStorage.removeItem("student"); 
        location.href = "../index.html"; 
    };
</script>
</body>
</html>
