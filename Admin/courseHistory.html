<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Course History</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    
    <!-- Custom CSS from admin_courses.html for a consistent UI -->
    <style>
        /* Google Font 'Inter' for a clean, modern look */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;700&display=swap');
        
        :root {
            --primary-bg: #E8F0F7; /* Soft Light Blue */
            --secondary-bg: #FFFFFF; /* White */
            --left-panel-bg: #2A5C88; /* Deep Blue */
            --card-bg: #FFFFFF; /* White */
            --accent-color: #4A90E2; /* Bright Light Blue */
            --text-light: #F7F7E8; /* Soft Cream */
            --text-dark: #2C3E50; /* Dark Gray-Blue */
            --input-border: #DDE0E3; /* Light Gray */
            --link-color: #4A90E2; /* Bright Light Blue */
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            background-color: var(--primary-bg);
        }
        
        .container-flex {
            display: flex;
            min-height: 100vh;
            overflow: hidden;
        }
        
        .sidebar {
            width: 250px;
            background-color: var(--left-panel-bg);
            color: var(--text-light);
            padding: 2rem 1.5rem;
            transition: transform 0.3s ease-in-out;
            transform: translateX(0);
            position: fixed;
            top: 0;
            bottom: 0;
            left: 0;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }
        
        .sidebar h4 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 2rem;
        }
        
        .sidebar a {
            color: var(--text-light);
            text-decoration: none;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.3s ease;
            font-weight: 400;
        }
        
        .sidebar a:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .sidebar a.active {
            background-color: var(--accent-color);
            color: var(--left-panel-bg);
            font-weight: 700;
        }
        
        .logout-link {
            margin-top: auto; /* Pushes the logout link to the bottom */
            background-color: var(--accent-color);
            color: var(--left-panel-bg) !important;
            text-align: center;
            font-weight: 700;
        }
        
        .logout-link:hover {
            background-color: #3A7DC1;
            color: var(--text-light) !important;
        }
        
        .main-content {
            flex: 1;
            margin-left: 250px;
            padding: 2rem;
            transition: margin-left 0.3s ease-in-out;
        }
        
        .dashboard-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-dark);
        }
        
        .card {
            border-radius: 1rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border: none;
            background-color: var(--card-bg);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
        }
        
        .card-title {
            color: var(--text-dark);
        }

        /* Make the card-body a flex container to align content */
        .card-body {
            display: flex;
            flex-direction: column;
        }

        /* Push the button to the bottom of the flex container */
        .card-body .btn {
            margin-top: auto;
        }

        .toggle-btn {
            position: fixed;
            top: 1rem;
            left: 1rem;
            background-color: var(--left-panel-bg);
            color: var(--text-light);
            border: none;
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            cursor: pointer;
            z-index: 1001;
            display: none; /* Hide on desktop */
        }
        
        .toggle-btn.hide {
            display: none;
        }

        /* Custom styles for Bootstrap primary button to match the theme */
        .btn-primary {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
            color: var(--left-panel-bg);
            font-weight: 700;
        }

        .btn-primary:hover {
            background-color: #3A7DC1;
            border-color: #3A7DC1;
        }

        /* Responsive styles for mobile */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.show {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .toggle-btn {
                display: block;
            }
        }
        
        /* Make the entire content scrollable on small screens */
        @media (max-width: 768px) {
            .container-flex {
                min-height: auto;
            }
            .main-content {
                padding-top: 5rem; /* Add space for the toggle button */
            }
        }
    </style>
</head>
<body>

    <!-- Toggle button for mobile -->
    <button class="toggle-btn" id="menu-toggle">☰ Menu</button>

    <div class="container-flex">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <h4 class="mb-4">Admin Panel</h4>
            <a href="admin_courses.html">Add Course</a>
            <a href="courseHistory.html" class="active">Courses History</a>
            <a href="admin_dashboard.html" class="logout-link">← Back</a>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <h2 class="dashboard-title">Course History</h2>
            <div id="loading" class="text-center my-4">Loading courses...</div>
            <div id="courseList" class="row"></div>
        </div>
    </div>

    <!-- Bootstrap Modal -->
    <div class="modal fade" id="allowModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Select Students to Allow Access</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="studentCheckboxes">
                    <p>Loading students...</p>
                </div>
                <div class="modal-footer">
                    <button type="button" id="saveAccessBtn" class="btn btn-primary">Save</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Status Message -->
    <div id="statusMessage" class="alert mt-3" style="display:none;"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Firebase + JS -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD_C4ZPXTXQZtZJbtAwTiub_rkIZcvsE2Y",
            authDomain: "clms-19db3.firebaseapp.com",
            projectId: "clms-19db3",
            storageBucket: "clms-19db3.firebasestorage.app",
            messagingSenderId: "218119035486",
            appId: "1:218119035486:web:39291d39b4b461b56032cf"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // DOM Elements
        const courseList = document.getElementById("courseList");
        const studentCheckboxes = document.getElementById("studentCheckboxes");
        const saveAccessBtn = document.getElementById("saveAccessBtn");
        const statusMessageDiv = document.getElementById("statusMessage");
        const loadingDiv = document.getElementById("loading");
        const sidebar = document.getElementById('sidebar');
        const menuToggleBtn = document.getElementById('menu-toggle');

        let currentCourseId = null;
        let currentCourseTitle = null;
        let allStudents = [];

        // Helper function to show status messages
        function showStatusMessage(message, type = 'info') {
            statusMessageDiv.textContent = message;
            statusMessageDiv.className = `alert mt-3 alert-${type}`;
            statusMessageDiv.style.display = 'block';
            setTimeout(() => {
                statusMessageDiv.style.display = 'none';
            }, 3000);
        }

        // Fetch students from Firestore
        async function loadStudents() {
            try {
                const studentsSnap = await getDocs(collection(db, "students"));
                allStudents = studentsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (error) {
                console.error("Error loading students:", error);
                showStatusMessage("Error loading students.", "danger");
            }
        }

        // Render course cards from Firestore data
        async function loadCourses() {
            courseList.innerHTML = "";
            loadingDiv.style.display = "block"; // Show loading indicator at the start
            try {
                const snapshot = await getDocs(collection(db, "courses"));
                
                if (snapshot.empty) {
                    courseList.innerHTML = "<p>No courses found.</p>";
                    return;
                }

                snapshot.forEach(docSnap => {
                    const course = docSnap.data();
                    const courseId = docSnap.id;

                    const card = document.createElement("div");
                    card.className = "col-md-6 mb-4";
                    card.innerHTML = `
                        <div class="card h-100 p-3">
                            <div class="card-body">
                                <h5 class="card-title">${course.title}</h5>
                                <p><strong>Start:</strong> ${course.startDate || 'N/A'}</p>
                                <p><strong>End:</strong> ${course.endDate || 'N/A'}</p>
                                <p><strong>Subjects:</strong> ${course.subjects?.join(', ') || 'N/A'}</p>
                                <p><strong>Weeks:</strong> ${course.weeks || 1}</p>
                                <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#allowModal" data-course-id="${courseId}" data-course-title="${course.title}">Allow Students</button>
                            </div>
                        </div>
                    `;
                    courseList.appendChild(card);
                });

                document.querySelectorAll("[data-bs-toggle='modal']").forEach(btn => {
                    btn.addEventListener("click", openAllowModal);
                });
            } catch (error) {
                console.error("Error loading courses:", error);
                showStatusMessage("Error loading courses.", "danger");
            } finally {
                 loadingDiv.style.display = "none"; // Always hide the loading indicator
            }
        }

        // Open the modal and populate with student data
        async function openAllowModal(event) {
            currentCourseId = event.target.dataset.courseId;
            currentCourseTitle = event.target.dataset.courseTitle;

            if (allStudents.length === 0) {
                await loadStudents();
            }

            try {
                const courseDocRef = doc(db, "courses", currentCourseId);
                const courseDocSnap = await getDoc(courseDocRef);
                let allowedStudents = [];
                if (courseDocSnap.exists()) {
                    allowedStudents = courseDocSnap.data().allowedStudents || [];
                }

                if (allStudents.length === 0) {
                    studentCheckboxes.innerHTML = "<p>No students found.</p>";
                } else {
                    studentCheckboxes.innerHTML = "";
                    allStudents.forEach(student => {
                        const isChecked = allowedStudents.includes(student.id);
                        const studentName = student.name || student.enrollment || student.id;
                        studentCheckboxes.insertAdjacentHTML("beforeend", `
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="${student.id}" id="student_${student.id}" ${isChecked ? "checked" : ""}>
                                <label class="form-check-label" for="student_${student.id}">${studentName}</label>
                            </div>
                        `);
                    });
                }
                const allowModal = new bootstrap.Modal(document.getElementById('allowModal'));
                allowModal.show();
            } catch (error) {
                console.error("Error preparing student access modal:", error);
                showStatusMessage("Error preparing student access modal.", "danger");
            }
        }
        function cleanupModalState() {
    document.body.classList.remove('modal-open');
    document.body.style.removeProperty('overflow');
    document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
}

        // Save the selected students to the course in Firestore
        async function saveAllowedStudents() {
    if (!currentCourseId) return;
    const selectedStudentIds = Array.from(studentCheckboxes.querySelectorAll('input[type="checkbox"]:checked'))
                                    .map(cb => cb.value);

    try {
        const courseDocRef = doc(db, "courses", currentCourseId);
        await setDoc(courseDocRef, { allowedStudents: selectedStudentIds }, { merge: true });
        showStatusMessage(`Allowed students saved for course "${currentCourseTitle}".`, "success");
    } catch (error) {
        console.error("Error saving allowed students:", error);
        showStatusMessage("Failed to save allowed students.", "danger");
    } finally {
        // Always hide the modal and cleanup, even if there was an error
        const modalInstance = bootstrap.Modal.getInstance(document.getElementById('allowModal'));
        if (modalInstance) modalInstance.hide();
        cleanupModalState();
    }
}

// Listen for the modal to be fully hidden and then refresh the course list
const allowModalElement = document.getElementById('allowModal');
allowModalElement.addEventListener('hidden.bs.modal', function () {
    cleanupModalState();
    loadCourses();
});

saveAccessBtn.addEventListener("click", saveAllowedStudents);

        // Sidebar toggle functionality
        menuToggleBtn.addEventListener('click', () => {
            sidebar.classList.toggle('show');
            // Fix: Also toggle the main content margin
            const mainContent = document.querySelector('.main-content');
            if (sidebar.classList.contains('show')) {
                mainContent.style.marginLeft = '250px';
            } else {
                mainContent.style.marginLeft = '0';
            }
        });

        // Hide sidebar when a link is clicked on mobile
        document.querySelectorAll('.sidebar a').forEach(link => {
            link.addEventListener('click', () => {
                if (sidebar.classList.contains('show')) {
                    sidebar.classList.remove('show');
                    menuToggleBtn.classList.remove('hide');
                    document.querySelector('.main-content').style.marginLeft = '0';
                }
            });
        });

        // Initial load
        window.onload = loadCourses;
    </script>
</body>
</html>
