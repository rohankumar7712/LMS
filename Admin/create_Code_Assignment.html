<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin: Create Code Assignment</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous" />
    <style>
        body {
            background-color: #f8f9fa;
        }
        .container {
            margin-top: 20px;
        }
        .card {
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .form-label {
            font-weight: 500;
        }
        .form-control {
            border-radius: 6px;
        }
        textarea.form-control {
            resize: vertical;
        }
    </style>
</head>
<body>

<div class="container">
    <h1 class="my-4 text-center">Create New Code Assignment</h1>
    <div class="card p-4">
        <form id="createAssignmentForm">
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="courseSelect" class="form-label">Course</label>
                    <select class="form-select" id="courseSelect" required>
                        <option value="">-- Select Course --</option>
                    </select>
                </div>
                <div class="col-md-4 mb-3">
                    <label for="subjectSelect" class="form-label">Subject</label>
                    <select class="form-select" id="subjectSelect" required>
                        <option value="">-- Select Subject --</option>
                    </select>
                </div>
                <div class="col-md-4 mb-3">
                    <label for="weekSelect" class="form-label">Week</label>
                    <select class="form-select" id="weekSelect" required>
                        <option value="">-- Select Week --</option>
                    </select>
                </div>
            </div>
            <div class="mb-3">
                <label for="assignmentTitle" class="form-label">Assignment Title</label>
                <input type="text" class="form-control" id="assignmentTitle" placeholder="e.g., Sasha and Brenda's Game" required />
            </div>
            <div class="mb-3">
                <label for="problemStatement" class="form-label">Problem Statement (Markdown Supported)</label>
                <textarea class="form-control" id="problemStatement" rows="8" placeholder="e.g., Design a program for Sasha and Brenda's game..." required></textarea>
            </div>

            <h3 class="mt-4 mb-3">Test Cases</h3>
            <div id="testCasesContainer">
                <div class="input-group mb-2 test-case-group">
                    <textarea class="form-control" placeholder="Input" required></textarea>
                    <textarea class="form-control ms-2" placeholder="Expected Output" required></textarea>
                    <button type="button" class="btn btn-outline-danger ms-2 remove-test-case">Remove</button>
                </div>
            </div>
            <button type="button" class="btn btn-secondary mt-2" id="addTestCaseBtn">Add Test Case</button>

            <div class="d-grid mt-4">
                <button type="submit" class="btn btn-primary btn-lg" id="saveAssignmentBtn">Save Assignment</button>
            </div>
        </form>
        <div id="statusMessage" class="mt-3 text-center"></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAPFlx9gVV6Q0a8Bwv4Et0OfytgIWApQng",
        authDomain: "clms-3b972.firebaseapp.com",
        projectId: "clms-3b972",
        storageBucket: "clms-3b972.appspot.com",
        messagingSenderId: "213199198013",
        appId: "1:213199198013:web:4a576ce4f4af68469b1754"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const form = document.getElementById('createAssignmentForm');
    const testCasesContainer = document.getElementById('testCasesContainer');
    const addTestCaseBtn = document.getElementById('addTestCaseBtn');
    const statusMessage = document.getElementById('statusMessage');
    const saveAssignmentBtn = document.getElementById('saveAssignmentBtn');

    const courseSelect = document.getElementById('courseSelect');
    const weekSelect = document.getElementById('weekSelect');
    const subjectSelect = document.getElementById('subjectSelect');

    // Load courses from root-level "courses" collection
    async function loadCourses() {
        try {
            const snapshot = await getDocs(collection(db, "courses"));
            courseSelect.innerHTML = `<option value="">-- Select Course --</option>`;
            snapshot.forEach(docSnap => {
                const data = docSnap.data();
                const option = document.createElement("option");
                option.value = docSnap.id;
                option.textContent = data.title || data.name || "Unnamed Course";
                courseSelect.appendChild(option);
            });
        } catch (err) {
            console.error("Error loading courses:", err);
            statusMessage.innerHTML = `<p class="text-danger">Error loading courses: ${err.message}</p>`;
        }
    }

    courseSelect.addEventListener("change", async () => {
        const courseId = courseSelect.value;
        weekSelect.innerHTML = `<option value="">-- Select Week --</option>`;
        subjectSelect.innerHTML = `<option value="">-- Select Subject --</option>`;

        if (!courseId) return;

        try {
            const courseDoc = await getDoc(doc(db, "courses", courseId));
            if (!courseDoc.exists()) return;

            const data = courseDoc.data();

            if (typeof data.weeks === 'number') {
                for (let i = 1; i <= data.weeks; i++) {
                    const opt = document.createElement("option");
                    opt.value = i;
                    opt.textContent = `Week ${i}`;
                    weekSelect.appendChild(opt);
                }
            }

            if (Array.isArray(data.subjects)) {
                data.subjects.forEach(subject => {
                    const opt = document.createElement("option");
                    opt.value = subject;
                    opt.textContent = subject;
                    subjectSelect.appendChild(opt);
                });
            }
        } catch (error) {
            console.error("Error loading course data:", error);
            statusMessage.innerHTML = `<p class="text-danger">Error loading course data: ${error.message}</p>`;
        }
    });

    addTestCaseBtn.addEventListener('click', () => {
        const newTestCaseGroup = document.createElement('div');
        newTestCaseGroup.className = 'input-group mb-2 test-case-group';
        newTestCaseGroup.innerHTML = `
            <textarea class="form-control" placeholder="Input" required></textarea>
            <textarea class="form-control ms-2" placeholder="Expected Output" required></textarea>
            <button type="button" class="btn btn-outline-danger ms-2 remove-test-case">Remove</button>
        `;
        testCasesContainer.appendChild(newTestCaseGroup);
    });

    testCasesContainer.addEventListener('click', (e) => {
        if (e.target.classList.contains('remove-test-case')) {
            e.target.closest('.test-case-group').remove();
        }
    });

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        statusMessage.innerHTML = `<p class="text-info">Saving assignment...</p>`;
        saveAssignmentBtn.disabled = true;

        const assignmentCourseId = courseSelect.value;
        const assignmentSubject = subjectSelect.value;
        const assignmentWeek = weekSelect.value;
        const assignmentTitle = document.getElementById('assignmentTitle').value.trim();
        const problemStatement = document.getElementById('problemStatement').value.trim();

        const testCases = [];
        document.querySelectorAll('.test-case-group').forEach(group => {
            const input = group.querySelector('textarea:nth-child(1)').value.trim();
            const expectedOutput = group.querySelector('textarea:nth-child(2)').value.trim();
            if (input && expectedOutput) {
                testCases.push({ input, expectedOutput });
            }
        });

        if (testCases.length === 0) {
            statusMessage.innerHTML = `<p class="text-danger">Please add at least one test case.</p>`;
            saveAssignmentBtn.disabled = false;
            return;
        }

        try {
            const assignmentsCollectionPath = "code_assignments";
            const newAssignmentRef = await addDoc(collection(db, assignmentsCollectionPath), {
                courseId: assignmentCourseId,
                subject: assignmentSubject,
                week: parseInt(assignmentWeek, 10),
                title: assignmentTitle,
                problemStatement: problemStatement,
                testCases: testCases,
                createdAt: new Date(),
                createdBy: "admin" // placeholder, no auth
            });

            statusMessage.innerHTML = `<p class="text-success">Assignment saved successfully! ID: ${newAssignmentRef.id}</p>`;
            form.reset();
            weekSelect.innerHTML = `<option value="">-- Select Week --</option>`;
            subjectSelect.innerHTML = `<option value="">-- Select Subject --</option>`;
            testCasesContainer.innerHTML = `
                <div class="input-group mb-2 test-case-group">
                    <textarea class="form-control" placeholder="Input" required></textarea>
                    <textarea class="form-control ms-2" placeholder="Expected Output" required></textarea>
                    <button type="button" class="btn btn-outline-danger ms-2 remove-test-case">Remove</button>
                </div>
            `;
        } catch (error) {
            console.error("Error adding document:", error);
            statusMessage.innerHTML = `<p class="text-danger">Error saving assignment: ${error.message}</p>`;
        } finally {
            saveAssignmentBtn.disabled = false;
        }
    });

    // Load courses on page load
    loadCourses();
</script>

</body>
</html>
