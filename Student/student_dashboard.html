<!-- student_dashboard.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Student Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f4f6f9;
    }
    .sidebar {
      height: 100vh;
      background-color: #2A5C88;
      color: white;
      padding: 1rem;
    }
    .sidebar a {
      display: block;
      padding: 0.75rem 1rem;
      color: white;
      text-decoration: none;
      margin-bottom: 0.5rem;
      border-radius: 8px;
    }
    .sidebar a:hover, .sidebar a.active {
      background-color: #1f4568;
    }
    .main-content {
      padding: 2rem;
    }
    .dashboard-title {
      color: #2A5C88;
      font-weight: 600;
      margin-bottom: 1rem;
    }
    .course-card {
      border-radius: 1rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      padding: 1rem;
      margin-bottom: 1rem;
      background-color: white;
    }
  </style>
</head>
<body>
<div class="container-fluid">
  <div class="row">
    <!-- Sidebar -->
    <div class="col-md-3 sidebar">
      <h4 class="mb-4">Student Panel</h4>
      <a href="student_dashboard.html" class="active">Dashboard</a>
      <a href="our_course.html">Course History</a>
      <a href="../index.html" onclick="logout()">Logout</a>
    </div>

    <!-- Main Content -->
    <div class="col-md-9 main-content">
      <h2 class="dashboard-title">Welcome 👋</h2>
      <p><em id="shayari"></em></p>

      <!-- Available Courses -->
      <h4 class="mt-4">Available Courses</h4>
      <div id="availableCourses"></div>
    </div>
  </div>
</div>

<!-- Enroll Modal -->
<div class="modal fade" id="enrollModal" tabindex="-1">
  <div class="modal-dialog">
    <form id="enrollForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Enroll in Course</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="selectedCourseId" />
        <div class="mb-3">
          <label class="form-label">Full Name</label>
          <input type="text" class="form-control" id="studentName" required />
        </div>
        <div class="mb-3">
          <label class="form-label">Enrollment No</label>
          <input type="text" class="form-control" id="enrollmentNumber" required />
        </div>
        <div class="mb-3">
          <label class="form-label">Email ID</label>
          <input type="email" class="form-control" id="emailId" required />
        </div>
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-success">Submit</button>
      </div>
    </form>
  </div>
</div>

<!-- Firebase & Firestore -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
import {
  getFirestore,
  collection,
  getDocs,
  query,
  where
} from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";;

  const firebaseConfig = {
    apiKey: "AIzaSyAPFlx9gVV6Q0a8Bwv4Et0OfytgIWApQng",
    authDomain: "clms-3b972.firebaseapp.com",
    projectId: "clms-3b972",
    storageBucket: "clms-3b972.appspot.com",
    messagingSenderId: "213199198013",
    appId: "1:213199198013:web:4a576ce4f4af68469b1754"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const shayaris = [
    "हर सुबह एक नई शुरुआत है।",
    "कभी हार मत मानो!",
    "जो खो गया उसके लिए रोया नहीं करते।",
    "सपने वो नहीं जो नींद में आए, सपने वो हैं जो नींद तोड़ दें।"
  ];
  document.getElementById("shayari").innerText = shayaris[Math.floor(Math.random() * shayaris.length)];

  const availableCoursesDiv = document.getElementById("availableCourses");

async function loadCourses() {
  const student = JSON.parse(localStorage.getItem("student"));
  if (!student) {
    alert("Unauthorized access. Please login again.");
    location.href = "../index.html";
    return;
  }

  // Step 1: Find student document ID by enrollment
  const studentsRef = collection(db, "students");
  const q = query(studentsRef, where("enrollment", "==", student.enrollment));
  const studentSnap = await getDocs(q);

  if (studentSnap.empty) {
    alert("Student record not found!");
    location.href = "../index.html";
    return;
  }

  const studentDoc = studentSnap.docs[0];
  const studentDocId = studentDoc.id;

  // Step 2: Fetch all courses
  const coursesSnapshot = await getDocs(collection(db, "courses"));

  // Step 3: Fetch enrollments for this student
  const enrollmentsSnapshot = await getDocs(collection(db, "enrollments"));
  const enrolledCourseIds = new Set();
  enrollmentsSnapshot.forEach(docSnap => {
    const data = docSnap.data();
    if (data.enrollment === student.enrollment) {
      enrolledCourseIds.add(data.courseId);
    }
  });

  // Step 4: Show allowed courses and mark enrolled ones
  availableCoursesDiv.innerHTML = "";

  coursesSnapshot.forEach(docSnap => {
    const course = docSnap.data();
    const courseId = docSnap.id;

    const allowedStudents = course.allowedStudents || [];
    if (!allowedStudents.includes(studentDocId)) {
      return; // Skip courses not allowed for this student
    }

    const isEnrolled = enrolledCourseIds.has(courseId);

    const courseDiv = document.createElement("div");
    courseDiv.className = "course-card";

    courseDiv.innerHTML = `
      <h5>${course.title}</h5>
      <p>${course.startDate} to ${course.endDate}</p>
      <button class="btn ${isEnrolled ? "btn-secondary" : "btn-success"} enroll-btn"
        data-course-id="${courseId}"
        ${isEnrolled ? "disabled" : `onclick="openEnrollModal('${courseId}')"`}>
        ${isEnrolled ? "Enrolled" : "Enroll"}
      </button>
    `;

    availableCoursesDiv.appendChild(courseDiv);
  });
}


  loadCourses();

  const enrollForm = document.getElementById("enrollForm");
  enrollForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const courseId = document.getElementById("selectedCourseId").value;
    const name = document.getElementById("studentName").value;
    const enrollment = document.getElementById("enrollmentNumber").value;
    const email = document.getElementById("emailId").value;

    try {
      await setDoc(doc(db, "enrollments", `${courseId}_${enrollment}`), {
        courseId, name, enrollment, email,
        enrolledAt: new Date().toISOString()
      });

      alert("Enrolled successfully!");
      const button = document.querySelector(`.enroll-btn[data-course-id="${courseId}"]`);
      if (button) {
        button.disabled = true;
        button.innerText = "Enrolled";
      }

      const modal = bootstrap.Modal.getInstance(document.getElementById("enrollModal"));
      modal.hide();
      enrollForm.reset();
    } catch (err) {
      alert("Error enrolling: " + err.message);
    }
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  window.openEnrollModal = function(courseId) {
  const student = JSON.parse(localStorage.getItem("student"));
  if (!student) return alert("Login expired. Please login again.");

  document.getElementById("selectedCourseId").value = courseId;
  document.getElementById("studentName").value = `${student.firstName} ${student.lastName}`;
  document.getElementById("enrollmentNumber").value = student.enrollment;
  document.getElementById("emailId").value = student.email;

  const enrollModal = new bootstrap.Modal(document.getElementById("enrollModal"));
  enrollModal.show();
};

  window.logout = () => {
    localStorage.removeItem("student");
    location.href = "../index.html";
  };
</script>
</body>
</html>
