<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Course History</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      background: #f5f9f8;
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      display: flex;
    }
    .sidebar {
      min-height: 100vh;
      background-color: #2A5C88;
      color: white;
      padding: 20px 10px;
      position: fixed;
      top: 0;
      left: 0;
      transition: transform 0.3s ease-in-out;
      z-index: 1000;
    }
    .sidebar h4 { font-weight: bold; margin-bottom: 30px; }
    .sidebar a {
      color: white;
      text-decoration: none;
      display: block;
      padding: 10px;
      border-radius: 8px;
      transition: background-color 0.3s ease;
      cursor: pointer;
    }
    .sidebar a:hover { background-color: #1d4568; }
    .sidebar a.active { background-color: #17405f; }
    .sidebar a.logout-link { color: #ffcccc !important; }
    .sidebar a.logout-link:hover { background-color: #c0392b; color: white !important; }
    .main-content { flex-grow: 1; padding: 20px; margin-left: 0; }
    .toggle-btn {
      display: none;
      background-color: #2A5C88;
      color: white;
      border: none;
      padding: 10px 15px;
      margin: 10px;
      position: fixed;
      top: 10px;
      left: 10px;
      z-index: 1001;
    }
    .course-history-card {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      padding: 15px;
      transition: transform 0.2s, box-shadow 0.2s;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    .course-history-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
    }
    .course-history-card h5 { font-weight: bold; color: #2A5C88; margin-bottom: 8px; font-size: 1.1em; }
    .course-history-card p { margin-bottom: 3px; color: #555; font-size: 0.9em; }
    .course-history-card .btn { width: 100%; padding: 8px; font-weight: bold; border-radius: 5px; margin-top: 10px; font-size: 0.9em; }
    @media (max-width: 768px) {
      body { display: block; }
      .sidebar { width: 200px; transform: translateX(-100%); }
      .sidebar.show { transform: translateX(0); }
      .toggle-btn { display: block; }
      .main-content { padding-top: 60px; }
    }
    @media (min-width: 769px) {
      .sidebar { width: 220px; transform: none; }
      .main-content { margin-left: 220px; }
    }
  </style>
</head>
<body>

<button class="toggle-btn" onclick="toggleSidebar()">â˜° Menu</button>

<div class="sidebar" id="sidebar">
  <h4>Student Panel</h4>
  <a href="student_dashboard.html">Dashboard</a>
  <a href="our_course.html" class="active">Course History</a>
  <a href="../index.html" class="logout-link" id="logoutBtn">Logout</a>
</div>

<div class="main-content">
  <h3>Enrolled Course History</h3>
  <div id="enrolledCourses" class="row"></div>
</div>

<div id="statusMessage" class="alert" style="display:none;"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
  import { getFirestore, collection, getDocs, doc, getDoc, query, where } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyD_C4ZPXTXQZtZJbtAwTiub_rkIZcvsE2Y",
    authDomain: "clms-19db3.firebaseapp.com",
    projectId: "clms-19db3",
    storageBucket: "clms-19db3.firebasestorage.app",
    messagingSenderId: "218119035486",
    appId: "1:218119035486:web:39291d39b4b461b56032cf"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const enrolledCoursesDiv = document.getElementById("enrolledCourses");
  const statusMessageDiv = document.getElementById("statusMessage");

  function showStatusMessage(message, type = 'info') {
    statusMessageDiv.textContent = message;
    statusMessageDiv.className = `alert mt-3 alert-${type}`;
    statusMessageDiv.style.display = 'block';
    setTimeout(() => statusMessageDiv.style.display = 'none', 3000);
  }

  async function loadEnrolledCourses() {
    const studentData = JSON.parse(localStorage.getItem("student"));
    if (!studentData || !studentData.enrollment) {
      showStatusMessage("Unauthorized access. Please login again.", "danger");
      window.location.href = "../index.html";
      return;
    }

    const enrollmentNumber = studentData.enrollment;
    enrolledCoursesDiv.innerHTML = `<div class="col-12 text-center my-4">
      <div class="spinner-border text-primary" role="status"></div>
    </div>`;

    try {
      const q = query(collection(db, "enrollments"), where("enrollment", "==", enrollmentNumber));
      const enrollmentsSnapshot = await getDocs(q);

      if (enrollmentsSnapshot.empty) {
        enrolledCoursesDiv.innerHTML = "<p class='col-12 text-center'>No courses enrolled.</p>";
        return;
      }

      const coursesData = await Promise.all(
        enrollmentsSnapshot.docs.map(async (enrollDoc) => {
          const { courseId } = enrollDoc.data();
          const courseRef = doc(db, "courses", courseId);
          const courseSnap = await getDoc(courseRef);
          return courseSnap.exists() ? { id: courseSnap.id, ...courseSnap.data() } : null;
        })
      );

      enrolledCoursesDiv.innerHTML = "";
      coursesData.filter(Boolean).forEach(course => {
        const subjectsList = Array.isArray(course.subjects) ? course.subjects.join(', ') : 'N/A';
        const col = document.createElement("div");
        col.className = "col-12 col-md-6 mb-4";
        col.innerHTML = `
          <div class="course-history-card">
            <h5>${course.title || 'N/A'}</h5>
            <p><strong>Start Date:</strong> ${course.startDate || 'N/A'}</p>
            <p><strong>End Date:</strong> ${course.endDate || 'N/A'}</p>
            <p><strong>Subjects:</strong> ${subjectsList}</p>
            <p><strong>Total Weeks:</strong> ${course.weeks || 'N/A'}</p>
            <button class="btn btn-primary go-to-course" data-id="${course.id}">Go to Course</button>
          </div>
        `;
        enrolledCoursesDiv.appendChild(col);
      });

      document.querySelectorAll(".go-to-course").forEach(btn => {
        btn.addEventListener("click", (e) => {
          window.location.href = `course_detail.html?courseId=${e.target.dataset.id}`;
        });
      });

    } catch (error) {
      console.error("Error loading enrolled courses:", error);
      showStatusMessage("Error loading enrolled courses: " + error.message, "danger");
    }
  }

  loadEnrolledCourses();

  document.getElementById("logoutBtn").addEventListener("click", () => {
    localStorage.removeItem("student");
    location.href = "../index.html";
  });

  window.toggleSidebar = function () {
    document.getElementById("sidebar").classList.toggle("show");
  };
</script>
</body>
</html>
