<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Code Assignment with Judge0</title>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      background-color: #f8f9fa;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    #editor {
      height: 400px;
      width: 100%;
      border-radius: 0.5rem;
      border: 1px solid #ced4da;
      font-size: 14px;
      line-height: 1.5;
    }
    .compiler-output {
      background-color: #212529;
      color: #e9ecef;
      border-radius: 0.5rem;
      padding: 1rem;
      white-space: pre-wrap;
      font-family: monospace;
      overflow-x: auto;
      min-height: 150px;
      margin-top: 0.5rem;
    }
    #custom-input {
      background-color: #212529;
      color: #e9ecef;
      border-color: #495057;
      resize: vertical;
      font-family: monospace;
      font-size: 14px;
    }
    #message-box > div {
      position: fixed;
      top: 1rem;
      right: 1rem;
      z-index: 1050;
      min-width: 280px;
      box-shadow: 0 0.25rem 0.75rem rgba(0,0,0,.1);
    }
    .problem-statement {
      background: white;
      border-radius: 0.5rem;
      padding: 1.5rem;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
      max-height: 600px;
      overflow-y: auto;
    }
    .table-responsive {
      max-height: 250px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <div class="container py-5">
    <div id="assignment-container" class="bg-white rounded-3 shadow p-4">
      <h1 class="text-primary mb-4 fw-bold">Code Assignment</h1>

      <div class="row gx-5 gy-4">
        <!-- Left: Problem Statement -->
        <div class="col-lg-5">
          <div class="problem-statement">
            <h2 class="h5 mb-3 border-bottom pb-2 text-secondary">Problem Statement</h2>
            <div id="problem-statement-content" class="text-dark fs-6">
              <p class="text-muted fst-italic">Loading problem details...</p>
            </div>

            <div id="test-cases-section" class="mt-4">
              <h3 class="h6 border-bottom pb-2 text-secondary">Sample Test Cases</h3>
              <div class="table-responsive">
                <table class="table table-sm table-bordered align-middle">
                  <thead class="table-light text-secondary">
                    <tr>
                      <th scope="col" style="width: 40%;">Input</th>
                      <th scope="col" style="width: 40%;">Expected Output</th>
                    </tr>
                  </thead>
                  <tbody id="test-cases-table-body">
                    <!-- Test cases will be inserted here -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Right: Editor + Controls -->
        <div class="col-lg-7 d-flex flex-column">
          <label for="language-select" class="form-label fw-semibold mb-2">Select Language</label>
          <select id="language-select" class="form-select mb-3" aria-label="Select Programming Language">
            <option value="54">C++ (GCC 9.2.0)</option>
            <option value="71">Python 3</option>
            <option value="63">JavaScript (Node.js)</option>
            <option value="62">Java (OpenJDK 13.0.1)</option>
          </select>

          <label for="editor" class="form-label bg-dark text-white p-2 rounded-top mb-0 fw-semibold">Write your code here</label>
          <div id="editor" class="border border-dark rounded-bottom flex-grow-1 mb-3"></div>

          <div class="form-check form-switch mb-2">
            <input class="form-check-input" type="checkbox" id="custom-input-toggle" />
            <label class="form-check-label" for="custom-input-toggle">Provide Custom Input</label>
          </div>
          <textarea
            id="custom-input"
            class="form-control d-none mb-3"
            rows="4"
            placeholder="Enter custom input here..."
            aria-label="Custom input"
          ></textarea>

          <h2 class="h6 mb-2 fw-semibold">Compiler Message</h2>
          <pre id="compiler-output" class="compiler-output">Output will be displayed here.</pre>

          <div class="d-flex gap-3 mt-4">
            <button id="clear-btn" class="btn btn-outline-danger flex-grow-1">Clear</button>
            <button id="run-btn" class="btn btn-primary flex-grow-1">Compile &amp; Run</button>
            <button id="submit-btn" class="btn btn-success flex-grow-1">Submit Code</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Message Box -->
    <div id="message-box"></div>
  </div>

  <!-- Ace Editor -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/mode-c_cpp.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/mode-python.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/mode-javascript.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/mode-java.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
    apiKey: "AIzaSyBYHB5XMte4Qj919ZsQWjoiFBcNrjl1xso",
    authDomain: "clms-dbfe1.firebaseapp.com",
    projectId: "clms-dbfe1",
    storageBucket: "clms-dbfe1.firebasestorage.app",
    messagingSenderId: "1025852714357",
    appId: "1:1025852714357:web:282d74003f389767ad773c"
  };

    let app, db, editor;
    let currentAssignment = {};

   let studentIdentifier = null;
try {
  const studentDataStr = localStorage.getItem("student");
  if (studentDataStr) {
    const studentData = JSON.parse(studentDataStr);
    studentIdentifier = studentData.enrollment;
  }
} catch {
  // ignore parse errors
}

if (!studentIdentifier) {
  alert("Student not logged in. Please login first.");
  window.location.href = "login.html"; // adjust your login URL here
  throw new Error("Student not logged in");
}


    function showMessage(message, type = 'success') {
      const messageBox = document.getElementById('message-box');
      const div = document.createElement('div');
      div.className = `alert alert-${type === 'success' ? 'success' : 'danger'} shadow`;
      div.textContent = message;
      messageBox.appendChild(div);
      setTimeout(() => {
        div.remove();
      }, 3500);
    }

    const params = new URLSearchParams(window.location.search);
    const assignmentId = params.get("assignmentId");
    if (!assignmentId) {
      showMessage("Assignment ID missing in URL.", "danger");
      throw new Error("Assignment ID missing");
    }

    async function init() {
      app = initializeApp(firebaseConfig);
      db = getFirestore(app);

      editor = ace.edit("editor");
      editor.setTheme("ace/theme/monokai");
      editor.session.setMode("ace/mode/c_cpp");
      editor.setOption("placeholder", "// Fill your code here");

      document.getElementById("language-select").addEventListener("change", (e) => {
        const langId = e.target.value;
        const editorMode = languageIdToAceMode(langId);
        editor.session.setMode(editorMode);
      });

      document.getElementById("custom-input-toggle").addEventListener("change", (e) => {
        const textarea = document.getElementById("custom-input");
        textarea.classList.toggle("d-none", !e.target.checked);
      });

      await loadAssignmentData();
    }

    function languageIdToAceMode(langId) {
      switch (langId) {
        case "54": return "ace/mode/c_cpp";
        case "71": return "ace/mode/python";
        case "63": return "ace/mode/javascript";
        case "62": return "ace/mode/java";
        default: return "ace/mode/plain_text";
      }
    }

    async function loadAssignmentData() {
      try {
        const docRef = doc(db, "code_assignments", assignmentId);
        const docSnap = await getDoc(docRef);

        if (docSnap.exists()) {
          currentAssignment = docSnap.data();
          renderAssignmentDetails();
        } else {
          showMessage("Assignment not found.", "danger");
          document.getElementById("problem-statement-content").innerHTML = `<p class="text-danger">Assignment not found.</p>`;
        }
      } catch (err) {
        console.error("Error loading assignment:", err);
        showMessage("Failed to load assignment.", "danger");
      }
    }

    function renderAssignmentDetails() {
      const div = document.getElementById("problem-statement-content");
      div.innerHTML = `
        <p><strong>${currentAssignment.problemStatement || "No problem statement provided."}</strong></p>
        ${currentAssignment.inputFormat ? `<h6 class="mt-3">Input Format:</h6><p>${currentAssignment.inputFormat}</p>` : ''}
        ${currentAssignment.outputFormat ? `<h6 class="mt-3">Output Format:</h6><p>${currentAssignment.outputFormat}</p>` : ''}
        ${currentAssignment.codeConstraints ? `<h6 class="mt-3">Constraints:</h6><p>${currentAssignment.codeConstraints}</p>` : ''}
      `;

      const tbody = document.getElementById("test-cases-table-body");
      tbody.innerHTML = "";
      if (currentAssignment.testCases && currentAssignment.testCases.length > 0) {
        currentAssignment.testCases.forEach(tc => {
          const tr = document.createElement("tr");

          const tdInput = document.createElement("td");
          tdInput.textContent = tc.input;
          tdInput.style.whiteSpace = "pre-wrap";

          const tdExpected = document.createElement("td");
          tdExpected.textContent = tc.expectedOutput;
          tdExpected.style.whiteSpace = "pre-wrap";

          tr.appendChild(tdInput);
          tr.appendChild(tdExpected);
          tbody.appendChild(tr);
        });
      } else {
        tbody.innerHTML = `<tr><td colspan="2" class="text-center text-muted">No sample test cases available.</td></tr>`;
      }
    }

    async function runCodeWithJudge0(code, input, languageId) {
      const payload = {
        source_code: code,
        stdin: input,
        language_id: Number(languageId)
      };

      const response = await fetch("https://judge0-ce.p.rapidapi.com/submissions?base64_encoded=false&wait=true", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-RapidAPI-Host": "judge0-ce.p.rapidapi.com",
          "X-RapidAPI-Key": "07cf44d014msh97fbec8a029cd8fp1cbefejsn3e8c791df367" // Replace with your RapidAPI key
        },
        body: JSON.stringify(payload),
      });

      if (!response.ok) {
        throw new Error("Failed to compile and run code");
      }

      const result = await response.json();

      if (result.stderr) {
        return `Error:\n${result.stderr}`;
      } else if (result.compile_output) {
        return `Compile error:\n${result.compile_output}`;
      } else {
        return result.stdout || "No output";
      }
    }

    document.getElementById("clear-btn").addEventListener("click", () => {
      editor.setValue("");
      document.getElementById("compiler-output").textContent = "Output cleared.";
    });

    document.getElementById("run-btn").addEventListener("click", async () => {
      const code = editor.getValue();
      const customInputToggle = document.getElementById("custom-input-toggle").checked;
      const customInput = document.getElementById("custom-input").value;
      const languageId = document.getElementById("language-select").value;

      let input = "";
      if (customInputToggle && customInput.trim() !== "") {
        input = customInput.trim();
      } else if (currentAssignment.testCases && currentAssignment.testCases.length > 0) {
        input = currentAssignment.testCases[0].input || "";
      }

      const outputEl = document.getElementById("compiler-output");
      outputEl.textContent = "Compiling and running...";

      try {
        const output = await runCodeWithJudge0(code, input, languageId);
        outputEl.textContent = output;
      } catch (error) {
        outputEl.textContent = "Error running code: " + error.message;
      }
    });

    async function saveSubmission({ studentId, assignmentId, code, languageId, testCaseDetails }) {
  try {
    // Use a unique doc id to avoid overwriting different submissions
    const submissionDocRef = doc(db, "code_submission", `${studentId}_${assignmentId}`);
    await setDoc(submissionDocRef, {
      studentId,
      assignmentId,
      code,
      languageId: Number(languageId),
      testCaseDetails,
      timestamp: serverTimestamp()
    });
    showMessage("Submission saved successfully.", "success");
  } catch (err) {
    console.error("Error saving submission:", err);
    showMessage("Failed to save submission.", "danger");
  }
}

    document.getElementById("submit-btn").addEventListener("click", async () => {
  if (!studentIdentifier) {
    showMessage("Student identifier missing. Cannot submit.", "danger");
    return;
  }

  const code = editor.getValue();
  const outputEl = document.getElementById("compiler-output");
  const languageId = document.getElementById("language-select").value;

  if (!currentAssignment.testCases || currentAssignment.testCases.length === 0) {
    showMessage("No test cases available to submit.", "danger");
    return;
  }

  outputEl.textContent = "Submitting and running all test cases...";

  let allPassed = true;
  let testCaseDetails = "";

  for (const testCase of currentAssignment.testCases) {
    try {
      const output = await runCodeWithJudge0(code, testCase.input, languageId);
      const expected = (testCase.expectedOutput || "").trim();
      const actual = output.trim();

      testCaseDetails += 
        `Input: \n${testCase.input}\n` +
        `Expected Output: \n${expected}\n` +
        `Actual Output: \n${actual}\n`;

      if (actual !== expected) {
        allPassed = false;
        testCaseDetails += "Status: FAILED\n\n";
      } else {
        testCaseDetails += "Status: PASSED\n\n";
      }
    } catch (error) {
      testCaseDetails += `Error running test case: ${error.message}\n\n`;
      allPassed = false;
    }
  }

  outputEl.textContent = testCaseDetails;

  await saveSubmission({
    studentId: studentIdentifier,
    assignmentId,
    code,
    languageId,
    testCaseDetails
  });

  if (allPassed) {
    showMessage("All test cases passed! Assignment submitted successfully.", "success");
  } else {
    showMessage("Some test cases failed. Please review your code.", "danger");
  }

  // Redirect to week_detail after 3s
  const weekNumber = currentAssignment.week || 1; // fallback if missing
  const url = `week_detail.html?courseId=${currentAssignment.courseId}&week=${weekNumber}&subject=${currentAssignment.subject}`;

  setTimeout(() => {
    window.location.href = url;
  }, 3000);
});
    window.onload = init;
  </script>
</body>
</html>
