<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Take Assignment</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body { background-color: #f4f6f9; }
    .assignment-card {
      background: white;
      border-radius: 10px;
      padding: 1.5rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      max-width: 700px;
      margin: 2rem auto;
    }
    .question-text {
      font-size: 1.2rem;
      margin-bottom: 1rem;
    }
    .nav-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 1.5rem;
    }
  </style>
</head>
<body>
  <div class="assignment-card">
    <h3 id="assignmentTitle">Loading Assignment...</h3>
    <p class="text-muted" id="assignmentMeta"></p>
    <hr />
    <div id="questionContainer">
      <p>Loading questions...</p>
    </div>
    <div class="nav-buttons">
      <button id="prevBtn" class="btn btn-secondary" disabled>Previous</button>
      <button id="nextBtn" class="btn btn-primary">Next</button>
    </div>
    <button id="submitBtn" class="btn btn-success mt-3" style="display:none;">Submit Assignment</button>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAPFlx9gVV6Q0a8Bwv4Et0OfytgIWApQng",
    authDomain: "clms-3b972.firebaseapp.com",
    projectId: "clms-3b972",
    storageBucket: "clms-3b972.appspot.com",
    messagingSenderId: "213199198013",
    appId: "1:213199198013:web:4a576ce4f4af68469b1754"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const params = new URLSearchParams(window.location.search);
  const assignmentId = params.get("assignmentId");
  if (!assignmentId) {
    alert("Invalid assignment ID.");
    throw new Error("No assignmentId found.");
  }

  // Sanitize Firestore doc id - replace forbidden chars with underscore
  function sanitizeId(id) {
    return id.replace(/[.#$/\[\]]/g, "_");
  }

  // Get studentId from localStorage and sanitize it
  const studentIdRaw = localStorage.getItem("studentId");
  if (!studentIdRaw) {
    alert("User not logged in. Please log in first.");
    window.location.href = "login.html";
    throw new Error("No studentId found in localStorage.");
  }
  const studentId = sanitizeId(studentIdRaw);

  let assignmentData = null;
  let questions = [];
  let currentIndex = 0;
  let submissionData = {};

  function shuffleArray(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  function redirectToWeekDetail() {
    const weekNumber = parseInt(assignmentData.week.replace('Week ', ''));
    const url = `week_detail.html?courseId=${assignmentData.courseId}&week=${weekNumber}&subject=${assignmentData.subject}`;
    window.location.href = url;
}

  function renderQuestion() {
    const q = questions[currentIndex];
    if (!q) {
      document.getElementById("questionContainer").innerHTML = "<p>No questions available.</p>";
      return;
    }

    const answerKey = `q_${currentIndex}`;
    const selectedAnswer = submissionData[answerKey]?.selected || null;

    let html = `<div class="question-text"><strong>Q${currentIndex + 1}:</strong> ${q.question}</div>`;

    ["a", "b", "c", "d"].forEach(opt => {
      if (q[opt]) {
        const checked = selectedAnswer === opt ? "checked" : "";
        html += `
          <div class="form-check">
            <input class="form-check-input" type="radio" name="answer" id="opt_${opt}" value="${opt}" ${checked}>
            <label class="form-check-label" for="opt_${opt}">${q[opt]}</label>
          </div>
        `;
      }
    });

    document.getElementById("questionContainer").innerHTML = html;

    document.getElementById("prevBtn").disabled = currentIndex === 0;
    document.getElementById("nextBtn").style.display = currentIndex === questions.length - 1 ? "none" : "inline-block";
    document.getElementById("submitBtn").style.display = currentIndex === questions.length - 1 ? "inline-block" : "none";
  }

  function saveCurrentAnswer() {
    const selectedInput = document.querySelector('input[name="answer"]:checked');
    const answerKey = `q_${currentIndex}`;
    submissionData[answerKey] = {
      selected: selectedInput ? selectedInput.value : null,
      correct: questions[currentIndex].correct || null
    };
  }

  async function checkSubmissionExists() {
    const submissionDocId = assignmentId + "_" + studentId;
    const subSnap = await getDoc(doc(db, "submissions", submissionDocId));
    if (subSnap.exists()) {
      alert("You have already submitted this assignment. Redirecting back.");
      redirectToWeekDetail();
      return true;
    }
    return false;
  }

  async function loadAssignment() {
    const snap = await getDoc(doc(db, "assignments", assignmentId));
    if (!snap.exists()) {
      alert("Assignment not found.");
      throw new Error("Assignment not found.");
    }
    assignmentData = snap.data();

    document.getElementById("assignmentTitle").innerText =
      `${assignmentData.subject} - ${assignmentData.week} Assignment`;
    document.getElementById("assignmentMeta").innerText =
      `Created: ${new Date(assignmentData.createdAt).toLocaleDateString()}`;

    // Combine all questions & shuffle
    questions = [];
    if (Array.isArray(assignmentData.mcq)) {
      assignmentData.mcq.forEach(q => questions.push(q));
    }
    if (Array.isArray(assignmentData.fillBlanks)) {
      assignmentData.fillBlanks.forEach(q => questions.push(q));
    }
    if (Array.isArray(assignmentData.trueFalse)) {
      assignmentData.trueFalse.forEach(q => questions.push(q));
    }
    questions = shuffleArray(questions);

    // Check previous submission
    const alreadySubmitted = await checkSubmissionExists();
    if (alreadySubmitted) return;

    // Load previous answers if any (optional)
    const submissionDocId = assignmentId + "_" + studentId;
    const subSnap = await getDoc(doc(db, "submissions", submissionDocId));
    submissionData = subSnap.exists() ? subSnap.data() : {};

    renderQuestion();
  }

  document.getElementById("nextBtn").onclick = () => {
    saveCurrentAnswer();
    if (currentIndex < questions.length - 1) {
      currentIndex++;
      renderQuestion();
    }
  };

  document.getElementById("prevBtn").onclick = () => {
    saveCurrentAnswer();
    if (currentIndex > 0) {
      currentIndex--;
      renderQuestion();
    }
  };

  document.getElementById("submitBtn").onclick = async () => {
    saveCurrentAnswer();

    const submissionDocId = assignmentId + "_" + studentId;

    const submission = {
      assignmentId,
      courseId: assignmentData.courseId,
      studentId,
      subject: assignmentData.subject,
      week: assignmentData.week,
      submittedAt: new Date().toISOString(),
      ...submissionData
    };

    try {
      await setDoc(doc(db, "submissions", submissionDocId), submission, { merge: true });
      alert("Assignment submitted successfully!");
      redirectToWeekDetail();
    } catch (err) {
      console.error("Error submitting assignment:", err);
      alert("Error submitting assignment. Please try again.");
    }
  };

  loadAssignment();
</script>
</body>
</html>
